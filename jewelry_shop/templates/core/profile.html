{% extends "core/base.html" %}
{% load static %}
{% block content %}
<style>
    .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 16px;
    }

    .profile-section {
        padding: 20px 0;
        text-align: center;
    }
    
    .profile-name {
        font-family: var(--heading-font);
        font-size: clamp(24px, 5vw, 32px);
        font-weight: 700;
        margin: 0 0 8px 0;
        word-break: break-word;
    }
    
    .profile-email {
        font-size: clamp(14px, 3vw, 16px);
        color: #666;
        margin: 0;
        word-break: break-all;
    }
    
    .info-section {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 20px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #E5E5E5;
    }
    
    .section-title {
        font-family: var(--heading-font);
        font-size: clamp(20px, 4vw, 24px);
        font-weight: 700;
        margin: 0 0 16px 0;
        text-align: center;
    }
    
    .info-item {
        margin-bottom: 16px;
    }
    
    .info-label {
        font-weight: 600;
        font-size: 14px;
        color: var(--text-color);
        margin-bottom: 8px;
        display: block;
    }
    
    .info-value {
        font-size: 14px;
        color: #666;
        background: #F8F8F8;
        padding: 12px;
        border-radius: 8px;
        border: 1px solid #E5E5E5;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        gap: 8px;
        word-break: break-word;
    }
    
    .info-value span {
        flex: 1;
        min-width: 0;
    }
    
    .edit-btn {
        background: var(--accent-color);
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        font-size: 12px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        flex-shrink: 0;
        min-width: 50px;
    }
    
    .edit-btn:hover {
        background: #A89476;
        transform: translateY(-1px);
    }
    
    .edit-input {
        width: 100%;
        background: white;
        border: 2px solid var(--accent-color);
        padding: 12px;
        border-radius: 8px;
        font-size: 14px;
        font-family: var(--body-font);
        outline: none;
        transition: border-color 0.3s ease;
        resize: vertical;
        min-height: 48px;
    }
    
    .edit-input:focus {
        border-color: #A89476;
    }
    
    .edit-actions {
        display: flex;
        gap: 8px;
        margin-top: 12px;
        flex-wrap: wrap;
    }
    
    .save-btn, .cancel-btn {
        padding: 8px 16px;
        border-radius: 6px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        border: none;
        flex: 1;
        min-width: 80px;
    }
    
    .save-btn {
        background: var(--accent-color);
        color: white;
    }
    
    .save-btn:hover {
        background: #A89476;
    }
    
    .cancel-btn {
        background: #F3F3F3;
        color: var(--text-color);
    }
    
    .cancel-btn:hover {
        background: #E8E8E8;
    }

    .spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid white;
        border-radius: 50%;
        width: 16px;
        height: 16px;
        animation: spin 0.8s linear infinite;
        margin: auto;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    /* Order History Table - Mobile Optimized */
    .order-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        border-radius: 8px;
        border: 1px solid #E5E5E5;
    }

    .order-table {
        width: 100%;
        min-width: 500px;
        border-collapse: collapse;
        background: white;
    }

    .order-table th {
        background: #F8F9FA;
        padding: 12px 8px;
        text-align: left;
        font-size: 11px;
        font-weight: 600;
        color: #6B7280;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        border-bottom: 1px solid #E5E7EB;
        white-space: nowrap;
    }

    .order-table td {
        padding: 12px 8px;
        font-size: 14px;
        border-bottom: 1px solid #F3F4F6;
        vertical-align: middle;
    }

    .order-table tr:hover {
        background: #F9FAFB;
    }

    .view-details-btn {
        background: #374151;
        color: white;
        padding: 6px 10px;
        border-radius: 6px;
        font-size: 11px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        border: none;
        white-space: nowrap;
    }

    .view-details-btn:hover {
        background: #4B5563;
        transform: translateY(-1px);
    }

    .view-details-btn:disabled {
        background: #9CA3AF;
        cursor: not-allowed;
        transform: none;
    }

    /* Mobile Cards for Orders */
    .order-cards {
        display: none;
    }

    .order-card {
        background: white;
        border-radius: 12px;
        padding: 16px;
        margin-bottom: 12px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        border: 1px solid #E5E5E5;
    }

    .order-card-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 12px;
        flex-wrap: wrap;
        gap: 8px;
    }

    .order-id {
        font-weight: 600;
        color: var(--text-color);
        font-size: 16px;
    }

    .order-date {
        color: #666;
        font-size: 14px;
    }

    .order-info-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 8px;
        flex-wrap: wrap;
        gap: 4px;
    }

    .order-total {
        font-weight: 700;
        color: var(--accent-color);
        font-size: 16px;
    }

    .order-status {
        background: #F0F9FF;
        color: #0369A1;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }

    /* Modal - Mobile Optimized */
    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.6);
        backdrop-filter: blur(4px);
        z-index: 60;
        display: none;
        align-items: center;
        justify-content: center;
        padding: 16px;
    }

    .modal.show {
        display: flex;
    }

    .modal-content {
        background: rgba(255,255,255,0.95);
        backdrop-filter: blur(20px);
        border-radius: 16px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        padding: 20px;
        max-width: 500px;
        width: 100%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        color: var(--text-color);
        border: 1px solid rgba(255,255,255,0.2);
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 12px;
        border-bottom: 1px solid #E5E5E5;
    }

    .modal-title {
        font-family: var(--heading-font);
        font-size: 20px;
        font-weight: 700;
        color: var(--text-color);
        margin: 0;
    }

    .close-btn {
        background: none;
        border: none;
        font-size: 24px;
        color: #666;
        cursor: pointer;
        padding: 4px;
        line-height: 1;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .close-btn:hover {
        background: #F3F4F6;
        color: var(--text-color);
    }

    .order-detail-item {
        margin-bottom: 12px;
        padding-bottom: 12px;
    }

    .order-detail-label {
        font-weight: 600;
        color: var(--text-color);
        font-size: 14px;
        margin-bottom: 4px;
    }

    .order-detail-value {
        color: #666;
        font-size: 14px;
    }

    .items-list {
        margin-top: 16px;
    }

    .item-card {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 12px;
        background: #F8F9FA;
        border-radius: 8px;
        margin-bottom: 8px;
    }

    .item-image {
        width: 48px;
        height: 48px;
        object-fit: cover;
        border-radius: 6px;
        flex-shrink: 0;
    }

    .item-info {
        flex: 1;
        min-width: 0;
    }

    .item-name {
        font-weight: 600;
        color: var(--text-color);
        font-size: 14px;
        margin-bottom: 4px;
        line-height: 1.3;
    }

    .item-details {
        color: #666;
        font-size: 12px;
        line-height: 1.3;
    }

    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 40px;
    }

    .spinner-large {
        border: 4px solid #f3f3f3;
        border-top: 4px solid var(--accent-color);
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
    }

    /* Responsive breakpoints */
    @media (max-width: 768px) {
        .container {
            padding: 12px;
        }

        .info-section {
            padding: 16px;
            margin-bottom: 16px;
        }

        .order-table-container {
            display: none;
        }

        .order-cards {
            display: block;
        }

        .modal-content {
            margin: 8px;
            padding: 16px;
            max-height: 85vh;
        }

        .item-card {
            padding: 10px;
            gap: 10px;
        }

        .item-image {
            width: 40px;
            height: 40px;
        }
    }

    @media (max-width: 480px) {
        .container {
            padding: 8px;
        }

        .profile-section {
            padding: 16px 0;
        }

        .info-section {
            padding: 12px;
            border-radius: 8px;
        }

        .info-value {
            padding: 10px;
            font-size: 13px;
            min-height: 44px;
        }

        .edit-btn {
            padding: 5px 8px;
            font-size: 11px;
            min-width: 45px;
        }

        .edit-input {
            padding: 10px;
            font-size: 14px;
            min-height: 44px;
        }

        .save-btn, .cancel-btn {
            padding: 8px 12px;
            font-size: 13px;
            min-width: 70px;
        }

        .order-card {
            padding: 12px;
        }

        .view-details-btn {
            padding: 6px 8px;
            font-size: 10px;
        }
    }
</style>

<title>Aura | User Profile</title>

<div class="container">
    <!-- Profile Header -->
    <div class="profile-section">
        <h2 class="profile-name">{{ user.username }}</h2>
        <p class="profile-email">{{ user.email }}</p>
    </div>  

    <!-- Contact Information Section -->
    <div class="info-section">
        <h3 class="section-title">Contact Information</h3>
        
        <!-- Phone Number -->
        <div class="info-item">
            <label class="info-label">Phone Number</label>
            <div class="info-value" id="phone-display">
                <span id="phone-text">{{ user.phone_number|default:"+91 98765 43210" }}</span>
                <button class="edit-btn" onclick="editPhone()">Edit</button>
            </div>
            <div id="phone-edit" style="display: none;">
                <input type="tel" class="edit-input" id="phone-input" placeholder="+91 XXXXX XXXXX">
                <div class="edit-actions">
                    <button class="save-btn" onclick="savePhone()">Save</button>
                    <button class="cancel-btn" onclick="cancelEdit('phone')">Cancel</button>
                </div>
            </div>
        </div>
        
        <!-- Shipping Address -->
        <div class="info-item">
            <label class="info-label">Shipping Address</label>
            <div class="info-value" id="address-display">
                <span id="address-text">{{ user.address|default:"No address added yet" }}</span>
                <button class="edit-btn" onclick="editAddress()">Edit</button>
            </div>
            <div id="address-edit" style="display: none;">
                <textarea class="edit-input" id="address-input" rows="3" placeholder="Enter your complete shipping address"></textarea>
                <div class="edit-actions">
                    <button class="save-btn" onclick="saveAddress()">Save</button>
                    <button class="cancel-btn" onclick="cancelEdit('address')">Cancel</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Order History Section -->
    <div class="info-section">
        <h3 class="section-title">Order History</h3>
        
        {% if orders %}
            <!-- Desktop Table View -->
            <div class="order-table-container">
                <table class="order-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Date</th>
                            <th>Total</th>
                            <th>Status</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for order in orders %}
                        <tr>
                            <td class="font-medium">#{{ order.id }}</td>
                            <td class="text-gray-600">{{ order.created_at|date:"M d, Y" }}</td>
                            <td class="font-bold">₹{{ order.total_amount }}</td>
                            <td>
                                <span class="order-status">{{ order.get_status_display }}</span>
                            </td>
                            <td>
                                <button onclick="showOrderDetails({{ order.id }})" class="view-details-btn">
                                    View Details
                                </button>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- Mobile Card View -->
            <div class="order-cards">
                {% for order in orders %}
                <div class="order-card">
                    <div class="order-card-header">
                        <span class="order-id">#{{ order.id }}</span>
                        <span class="order-date">{{ order.created_at|date:"M d, Y" }}</span>
                    </div>
                    <div class="order-info-row">
                        <span class="order-total">₹{{ order.total_amount }}</span>
                        <span class="order-status">{{ order.get_status_display }}</span>
                    </div>
                    <div style="margin-top: 12px;">
                        <button onclick="showOrderDetails({{ order.id }})" class="view-details-btn" style="width: 100%;">
                            View Details
                        </button>
                    </div>
                </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="text-center py-12">
                <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" class="mx-auto mb-4 text-gray-400">
                    <circle cx="12" cy="12" r="10"></circle>
                    <path d="M16 16s-1.5-2-4-2-4 2-4 2"></path>
                    <path d="M9 9h.01"></path>
                    <path d="M15 9h.01"></path>
                </svg>
                <p class="text-gray-500 text-lg">No orders yet</p>
                <p class="text-gray-400 text-sm mt-2">Start shopping to see your orders here!</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Order Details Modal -->
<div id="orderModal" class="modal">
    <div class="modal-content">
        <div class="modal-header">
            <h3 class="modal-title">Order Details</h3>
            <button onclick="closeModal()" class="close-btn" aria-label="Close">&times;</button>
        </div>
        <div id="orderDetails">
            <div class="loading-spinner">
                <div class="spinner-large"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Store original values
    let originalPhone = document.getElementById('phone-text').textContent.trim();
    let originalAddress = document.getElementById('address-text').textContent.trim();
    
    // Cache for order details to avoid repeated API calls
    const orderCache = new Map();

    // ---------- Edit Functions ----------
    function editPhone() {
        document.getElementById('phone-display').style.display = 'none';
        document.getElementById('phone-edit').style.display = 'block';
        document.getElementById('phone-input').value = originalPhone;
        document.getElementById('phone-input').focus();
    }

    function editAddress() {
        document.getElementById('address-display').style.display = 'none';
        document.getElementById('address-edit').style.display = 'block';
        document.getElementById('address-input').value = originalAddress;
        document.getElementById('address-input').focus();
    }

    // ---------- Save Functions (with loading) ----------
    function savePhone() {
        const newPhone = document.getElementById('phone-input').value.trim();
        if (!newPhone) {
            alert('Please enter a valid phone number');
            return;
        }

        const saveBtn = document.querySelector("#phone-edit .save-btn");
        toggleLoading(saveBtn, true);

        sendUpdate("phone_number", newPhone, function(success) {
            toggleLoading(saveBtn, false);
            if (success) {
                document.getElementById('phone-text').textContent = newPhone;
                originalPhone = newPhone;
                cancelEdit('phone');
            } else {
                alert("Failed to update phone. Try again.");
            }
        });
    }

    function saveAddress() {
        const newAddress = document.getElementById('address-input').value.trim();
        if (!newAddress) {
            alert('Please enter a valid address');
            return;
        }

        const saveBtn = document.querySelector("#address-edit .save-btn");
        toggleLoading(saveBtn, true);

        sendUpdate("address", newAddress, function(success) {
            toggleLoading(saveBtn, false);
            if (success) {
                document.getElementById('address-text').textContent = newAddress;
                originalAddress = newAddress;
                cancelEdit('address');
            } else {
                alert("Failed to update address. Try again.");
            }
        });
    }

    // ---------- Cancel Edit ----------
    function cancelEdit(type) {
        if (type === 'phone') {
            document.getElementById('phone-display').style.display = 'flex';
            document.getElementById('phone-edit').style.display = 'none';
            document.getElementById('phone-input').value = originalPhone;
        } else if (type === 'address') {
            document.getElementById('address-display').style.display = 'flex';
            document.getElementById('address-edit').style.display = 'none';
            document.getElementById('address-input').value = originalAddress;
        }
    }

    // ---------- AJAX Request ----------
    function sendUpdate(field, value, callback) {
        fetch("{% url 'core:update_profile_field' %}", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": "{{ csrf_token }}",
                "X-Requested-With": "XMLHttpRequest"
            },
            body: new URLSearchParams({
                "field": field,
                "value": value
            })
        })
        .then(response => response.json())
        .then(data => callback(data.success))
        .catch(() => callback(false));
    }

    // ---------- Toggle Loading State ----------
    function toggleLoading(button, isLoading) {
        if (isLoading) {
            button.disabled = true;
            button.innerHTML = `<div class="spinner"></div>`;
        } else {
            button.disabled = false;
            button.textContent = "Save";
        }
    }

    // ---------- Order Details Functions (Optimized) ----------
    function showOrderDetails(orderId) {
        const modal = document.getElementById("orderModal");
        const detailsContainer = document.getElementById("orderDetails");
        
        // Show modal immediately
        modal.classList.add("show");
        
        // Check cache first
        if (orderCache.has(orderId)) {
            detailsContainer.innerHTML = orderCache.get(orderId);
            return;
        }
        
        // Show loading state
        detailsContainer.innerHTML = `
            <div class="loading-spinner">
                <div class="spinner-large"></div>
            </div>
        `;
        
        // Disable all view details buttons to prevent multiple requests
        const buttons = document.querySelectorAll('.view-details-btn');
        buttons.forEach(btn => {
            btn.disabled = true;
            btn.textContent = 'Loading...';
        });

        // Fetch order details with timeout
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

        fetch("{% url 'orders:order_details_api' 0 %}".replace("0", orderId), {
            signal: controller.signal
        })
        .then(response => {
            clearTimeout(timeoutId);
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            const html = generateOrderDetailsHTML(data);
            detailsContainer.innerHTML = html;
            
            // Cache the result
            orderCache.set(orderId, html);
        })
        .catch(error => {
            console.error('Error fetching order details:', error);
            detailsContainer.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-red-600 mb-2">Failed to load order details</p>
                    <button onclick="showOrderDetails(${orderId})" class="view-details-btn">Try Again</button>
                </div>
            `;
        })
        .finally(() => {
            // Re-enable all buttons
            buttons.forEach(btn => {
                btn.disabled = false;
                btn.textContent = 'View Details';
            });
        });
    }

    function generateOrderDetailsHTML(data) {
        let html = `
            <div class="order-detail-item">
                <div class="order-detail-label">Order ID</div>
                <div class="order-detail-value">#${data.id}</div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Status</div>
                <div class="order-detail-value">
                    <span class="order-status">${data.status}</span>
                </div>
            </div>
            <div class="order-detail-item">
                <div class="order-detail-label">Total Amount</div>
                <div class="order-detail-value order-total">₹${data.total_amount}</div>
            </div>
        `;

        if (data.items && data.items.length > 0) {
            html += `
                <div class="items-list">
                    <div class="order-detail-label" style="margin-bottom: 12px;">Items Ordered</div>
            `;
            
            data.items.forEach(item => {
                html += `
                    <div class="item-card">
                        <img src="${item.image || '/static/images/placeholder.jpg'}" 
                             alt="${item.name}" 
                             class="item-image"
                             onerror="this.src='/static/images/placeholder.jpg'">
                        <div class="item-info">
                            <div class="item-name">${item.name}</div>
                            <div class="item-details">
                                Qty: ${item.quantity} × ₹${item.price} = <strong>₹${item.total}</strong>
                            </div>
                        </div>
                    </div>
                `;
            });
            html += `</div>`;
        }
        
        return html;
    }

    function closeModal() {
        const modal = document.getElementById("orderModal");
        modal.classList.remove("show");
    }

    // Close modal when clicking outside
    document.getElementById("orderModal").addEventListener('click', function(e) {
        if (e.target === this) {
            closeModal();
        }
    });

    // Close modal with Escape key
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeModal();
        }
    });

    // Prevent modal content clicks from closing modal
    document.querySelector('.modal-content').addEventListener('click', function(e) {
        e.stopPropagation();
    });
</script>

{% endblock %}