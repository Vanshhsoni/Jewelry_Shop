{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Custom Admin Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen">

  <div class="container mx-auto p-6 grid grid-cols-12 gap-6">
    
    <!-- Categories Panel -->
    <section class="col-span-12 lg:col-span-4">
      <div class="bg-white p-4 rounded shadow">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold">Categories</h2>
          <button id="openAddCategory" class="px-3 py-1 bg-[#BDA78B] text-white rounded">+ Add Category</button>
        </div>
        <div id="categoriesList" class="space-y-2">
          {% if categories %}
            {% for c in categories %}
              <button data-cat-id="{{ c.id }}" class="block w-full text-left px-3 py-2 border rounded hover:bg-gray-100">
                {{ c.name }}
              </button>
            {% endfor %}
          {% else %}
            <p class="text-sm text-gray-500">No categories yet.</p>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Products Panel -->
    <section class="col-span-12 lg:col-span-8">
      <div class="bg-white p-4 rounded shadow">
        <div class="flex items-center justify-between mb-4">
          <h2 id="productsHeading" class="font-semibold">Select a category</h2>
          <button id="openAddProduct" 
                  class="px-3 py-1 bg-[#BDA78B] text-white rounded disabled:opacity-50" 
                  disabled>
            + Add Product
          </button>
        </div>
        <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
          <p class="text-sm text-gray-500">No category selected.</p>
        </div>
      </div>
    </section>
  </div>

  <!-- Add Category Modal -->
  <div id="modalCategory" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-40">
    <div class="bg-white p-6 rounded w-full max-w-md shadow-lg">
      <h3 class="font-semibold mb-3">Add Category</h3>
      <form id="formCategory" enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <input name="name" placeholder="Category name" class="w-full mb-2 p-2 border rounded" required/>
        <input type="file" name="image" accept="image/*" class="mb-3" required/>
        <div class="flex justify-end gap-2">
          <button type="button" id="closeCategory" class="px-3 py-1">Cancel</button>
          <button type="submit" class="px-3 py-1 bg-[#BDA78B] text-white rounded">Create</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Add Product Modal -->
  <div id="modalProduct" class="fixed inset-0 hidden items-center justify-center bg-black/40 z-40">
    <div class="bg-white p-6 rounded w-full max-w-lg shadow-lg">
      <h3 class="font-semibold mb-3">Add Product</h3>
      <form id="formProduct" enctype="multipart/form-data" method="post">
        {% csrf_token %}
        <input type="hidden" name="category" id="product_category_id"/>
        <input name="name" placeholder="Product name" class="w-full mb-2 p-2 border rounded" required/>
        <input type="file" name="image" accept="image/*" class="mb-2" required/>
        <textarea name="description" placeholder="Description" class="w-full mb-2 p-2 border rounded"></textarea>
        <div class="grid grid-cols-2 gap-2 mb-2">
          <label class="flex items-center gap-2">
            <input type="checkbox" name="is_available" checked/> Available
          </label>
          <label class="flex items-center gap-2">
            <input type="checkbox" name="is_featured"/> Featured
          </label>
        </div>
        <input name="price" type="number" step="0.01" placeholder="Price" class="w-full mb-3 p-2 border rounded" required/>
        <div class="flex justify-end gap-2">
          <button type="button" id="closeProduct" class="px-3 py-1">Cancel</button>
          <button type="submit" class="px-3 py-1 bg-[#BDA78B] text-white rounded">Create</button>
        </div>
      </form>
    </div>
  </div>
  <button class="logout-btn" 
  onclick="window.location.href='{% url 'accounts:logout' %}'">
Logout
</button>
  <script>
    const modalCategory = document.getElementById("modalCategory");
    const modalProduct = document.getElementById("modalProduct");
    const openAddCategory = document.getElementById("openAddCategory");
    const closeCategory = document.getElementById("closeCategory");
    const openAddProduct = document.getElementById("openAddProduct");
    const closeProduct = document.getElementById("closeProduct");
    const categoriesList = document.getElementById("categoriesList");
    const productCategoryInput = document.getElementById("product_category_id");
    const productsHeading = document.getElementById("productsHeading");
    const productsGrid = document.getElementById("productsGrid");
    
    let selectedCategoryId = null;
    
    // Modal handling
    openAddCategory.addEventListener("click", () => modalCategory.classList.remove("hidden"));
    closeCategory.addEventListener("click", () => modalCategory.classList.add("hidden"));
    openAddProduct.addEventListener("click", () => {
      if (!selectedCategoryId) return;
      productCategoryInput.value = selectedCategoryId;
      modalProduct.classList.remove("hidden");
    });
    closeProduct.addEventListener("click", () => modalProduct.classList.add("hidden"));
    
    // AJAX: create category
    document.getElementById("formCategory").addEventListener("submit", async function(e){
      e.preventDefault();
      const formData = new FormData(this);
      const res = await fetch("{% url 'adminpanel:create_category' %}", { method: "POST", body: formData });
      const data = await res.json();
      if(data.ok){
        // add new category button
        const btn = document.createElement("button");
        btn.dataset.catId = data.id;
        btn.className = "block w-full text-left px-3 py-2 border rounded hover:bg-gray-100";
        btn.textContent = data.name;
        categoriesList.appendChild(btn);
        this.reset();
        modalCategory.classList.add("hidden");
      } else {
        alert(JSON.stringify(data.errors));
      }
    });
    
    // AJAX: create product
    document.getElementById("formProduct").addEventListener("submit", async function(e){
      e.preventDefault();
      const formData = new FormData(this);
      const res = await fetch("{% url 'adminpanel:create_product' %}", { method: "POST", body: formData });
      const data = await res.json();
      if(data.ok){
        // refresh products grid
        const btn = categoriesList.querySelector(`button[data-cat-id="${selectedCategoryId}"]`);
        btn.click(); // triggers fetch products for this category
        this.reset();
        modalProduct.classList.add("hidden");
      } else {
        alert(JSON.stringify(data.errors));
      }
    });
    
    // Category selection & fetch products
    categoriesList.addEventListener("click", async (e) => {
      const btn = e.target.closest("button[data-cat-id]");
      if(!btn) return;
      selectedCategoryId = btn.dataset.catId;
      productsHeading.textContent = `Products — ${btn.textContent}`;
      openAddProduct.disabled = false;
    
      const res = await fetch(`/adminpanel/category/${selectedCategoryId}/products/`);
      const data = await res.json();
      productsGrid.innerHTML = "";
      if(data.products.length === 0){
        productsGrid.innerHTML = `<p class="text-sm text-gray-500">No products in ${btn.textContent}.</p>`;
      } else {
        data.products.forEach(p => {
          const div = document.createElement("div");
          div.className = "border rounded p-3 bg-white";
          div.innerHTML = `
            <div class="h-40 bg-gray-100 mb-3 flex items-center justify-center">
              <img src="${p.image_url}" alt="${p.name}" class="max-h-full object-contain"/>
            </div>
            <div class="font-medium">${p.name}</div>
            <div class="text-sm text-gray-600">₹${p.price}</div>
            <div class="flex items-center gap-2 mt-2">
              <label><input type="checkbox" data-id="${p.id}" data-field="is_available" ${p.is_available ? "checked" : ""}/> Available</label>
              <label><input type="checkbox" data-id="${p.id}" data-field="is_featured" ${p.is_featured ? "checked" : ""}/> Featured</label>
              <button data-id="${p.id}" class="ml-auto text-red-500 delete-product">Delete</button>
            </div>
          `;
          productsGrid.appendChild(div);
        });
      }
    });
    </script>
    
</body>
</html>
