{% extends "core/base.html" %}
{% load static %}

{% block title %}Custom Admin Dashboard{% endblock %}

{% block content %}
<!-- Loading Overlay -->
<div id="loadingOverlay" class="fixed inset-0 bg-gradient-to-br from-amber-50/90 to-orange-100/90 backdrop-blur-sm flex items-center justify-center z-50 hidden">
  <div class="bg-white/80 backdrop-blur-md rounded-2xl p-8 shadow-2xl border border-amber-200/50">
    <div class="flex flex-col items-center space-y-4">
      <div class="relative">
        <div class="w-12 h-12 border-4 border-amber-200 rounded-full animate-pulse"></div>
        <div class="absolute inset-0 w-12 h-12 border-4 border-[#BDA78B] border-t-transparent rounded-full animate-spin"></div>
      </div>
      <p class="text-[#8B7355] font-medium">Loading...</p>
    </div>
  </div>
</div>

<!-- Main Dashboard -->
<div class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-yellow-50">
  <div class="container mx-auto p-4 lg:p-6 grid grid-cols-12 gap-6">
    
    <!-- Categories Panel -->
    <section class="col-span-12 lg:col-span-4 category-panel">
      <div class="bg-white/70 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-amber-200/50 hover:shadow-2xl transition-all duration-300">
        <div class="flex items-center justify-between mb-6">
          <h2 class="font-bold text-xl text-[#6B5B47] flex items-center gap-2">
            <span class="w-2 h-2 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] rounded-full"></span>
            Categories
          </h2>
          <button id="openAddCategory" class="group px-4 py-2 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
            <span class="group-hover:scale-110 transition-transform duration-200">+</span> Add Category
          </button>
        </div>
        <div id="categoriesList" class="space-y-3">
          {% if categories %}
            {% for c in categories %}
              <div class="category-item flex items-center gap-3 opacity-0 animate-fadeInUp" style="animation-delay: {{ forloop.counter0|floatformat:1 }}00ms">
                <button data-cat-id="{{ c.id }}" 
                        data-cat-name="{{ c.name }}"
                        class="category-btn flex-1 text-left px-4 py-3 border-2 border-amber-200/50 rounded-xl hover:bg-gradient-to-r hover:from-amber-50 hover:to-orange-50 transition-all duration-300 font-medium text-[#6B5B47] hover:border-[#BDA78B]/50 hover:shadow-md transform hover:translate-y-[-2px]">
                  {{ c.name }}
                </button>
                <button data-cat-id="{{ c.id }}" 
                        data-cat-name="{{ c.name }}"
                        class="edit-category-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200 hover:scale-110">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                  </svg>
                </button>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-center py-8">
              <div class="w-16 h-16 bg-gradient-to-r from-amber-200 to-orange-200 rounded-full flex items-center justify-center mx-auto mb-3">
                <svg class="w-8 h-8 text-[#8B7355]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
                </svg>
              </div>
              <p class="text-[#8B7355]">No categories yet. Create your first one!</p>
            </div>
          {% endif %}
        </div>
      </div>
    </section>

    <!-- Products Panel -->
    <section class="col-span-12 lg:col-span-8 products-panel">
      <div class="bg-white/70 backdrop-blur-md p-6 rounded-2xl shadow-xl border border-amber-200/50 hover:shadow-2xl transition-all duration-300">
        <div class="flex items-center justify-between mb-6">
          <h2 id="productsHeading" class="font-bold text-xl text-[#6B5B47] flex items-center gap-2">
            <span class="w-2 h-2 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] rounded-full"></span>
            Select a category
          </h2>
          <button id="openAddProduct" 
                  class="group px-4 py-2 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed disabled:transform-none font-medium" 
                  disabled>
            <span class="group-hover:scale-110 transition-transform duration-200">+</span> Add Product
          </button>
        </div>
        <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="col-span-full text-center py-12">
            <div class="w-20 h-20 bg-gradient-to-r from-amber-200 to-orange-200 rounded-full flex items-center justify-center mx-auto mb-4">
              <svg class="w-10 h-10 text-[#8B7355]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
              </svg>
            </div>
            <p class="text-[#8B7355] text-lg">Choose a category to view products</p>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<!-- Add/Edit Category Modal -->
<div id="modalCategory" class="fixed inset-0 hidden items-center justify-center bg-black/20 backdrop-blur-sm z-50 p-4">
  <div class="modal-content bg-white/90 backdrop-blur-md p-8 rounded-3xl w-full max-w-md shadow-2xl border border-amber-200/50 transform scale-95 opacity-0 transition-all duration-300">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-8 h-8 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] rounded-lg flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"></path>
        </svg>
      </div>
      <h3 id="categoryModalTitle" class="font-bold text-xl text-[#6B5B47]">Add Category</h3>
    </div>
    
    <div id="categoryFormSpinner" class="hidden text-center py-4">
      <div class="inline-block w-6 h-6 border-2 border-[#BDA78B] border-t-transparent rounded-full animate-spin"></div>
      <p class="text-[#8B7355] mt-2">Processing...</p>
    </div>
    
    <form id="formCategory" enctype="multipart/form-data" method="post">
      {% csrf_token %}
      <input type="hidden" id="category_id" name="category_id"/>
      
      <div class="space-y-5">
        <div>
          <label class="block text-sm font-semibold text-[#6B5B47] mb-2">Category Name</label>
          <input name="name" id="category_name" placeholder="Enter category name" 
                 class="w-full p-4 border-2 border-amber-200/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-[#BDA78B]/20 focus:border-[#BDA78B] transition-all duration-200 bg-white/50 backdrop-blur-sm font-medium text-[#6B5B47] placeholder-amber-400/70 transform focus:scale-[1.02]" required/>
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-[#6B5B47] mb-2">Category Image</label>
          <div class="relative">
            <input type="file" name="image" id="category_image" accept="image/*" 
                   class="w-full p-4 border-2 border-amber-200/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-[#BDA78B]/20 focus:border-[#BDA78B] transition-all duration-200 bg-white/50 backdrop-blur-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-gradient-to-r file:from-[#BDA78B] file:to-[#A68B74] file:text-white file:font-medium hover:file:shadow-lg file:transition-all file:duration-200"/>
          </div>
        </div>
        
        <div id="current_image_preview" class="hidden">
          <label class="block text-sm font-semibold text-[#6B5B47] mb-2">Current Image</label>
          <div class="p-4 bg-gradient-to-r from-amber-100/50 to-orange-100/50 rounded-xl border border-amber-200/50">
            <img id="current_image" src="" alt="Current category image" class="w-24 h-24 object-cover rounded-xl shadow-lg mx-auto">
          </div>
        </div>
      </div>
      
      <div class="flex justify-end gap-3 mt-8">
        <button type="button" id="closeCategory" class="px-6 py-3 text-[#6B5B47] hover:bg-amber-100/50 rounded-xl transition-all duration-200 font-medium hover:scale-105">
          Cancel
        </button>
        <button type="submit" id="submitCategory" class="px-8 py-3 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
          Create
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Add/Edit Product Modal -->
<div id="modalProduct" class="fixed inset-0 hidden items-center justify-center bg-black/20 backdrop-blur-sm z-50 p-4">
  <div class="modal-content bg-white/90 backdrop-blur-md p-8 rounded-3xl w-full max-w-2xl shadow-2xl border border-amber-200/50 max-h-[90vh] overflow-y-auto transform scale-95 opacity-0 transition-all duration-300">
    <div class="flex items-center gap-3 mb-6">
      <div class="w-8 h-8 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] rounded-lg flex items-center justify-center">
        <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"></path>
        </svg>
      </div>
      <h3 id="productModalTitle" class="font-bold text-xl text-[#6B5B47]">Add Product</h3>
    </div>
    
    <div id="productFormSpinner" class="hidden text-center py-4">
      <div class="inline-block w-6 h-6 border-2 border-[#BDA78B] border-t-transparent rounded-full animate-spin"></div>
      <p class="text-[#8B7355] mt-2">Processing...</p>
    </div>
    
    <form id="formProduct" enctype="multipart/form-data" method="post">
      {% csrf_token %}
      <input type="hidden" name="category" id="product_category_id"/>
      <input type="hidden" id="product_id" name="product_id"/>
      
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="space-y-5">
          <div>
            <label class="block text-sm font-semibold text-[#6B5B47] mb-2">Product Name</label>
            <input name="name" id="product_name" placeholder="Enter product name" 
                   class="w-full p-4 border-2 border-amber-200/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-[#BDA78B]/20 focus:border-[#BDA78B] transition-all duration-200 bg-white/50 backdrop-blur-sm font-medium text-[#6B5B47] placeholder-amber-400/70 transform focus:scale-[1.02]" required/>
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-[#6B5B47] mb-2">Price (₹)</label>
            <input name="price" id="product_price" type="number" step="0.01" placeholder="0.00" 
                   class="w-full p-4 border-2 border-amber-200/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-[#BDA78B]/20 focus:border-[#BDA78B] transition-all duration-200 bg-white/50 backdrop-blur-sm font-medium text-[#6B5B47] placeholder-amber-400/70 transform focus:scale-[1.02]" required/>
          </div>
          
          <div>
            <label class="block text-sm font-semibold text-[#6B5B47] mb-2">Product Image</label>
            <input type="file" name="image" id="product_image" accept="image/*" 
                   class="w-full p-4 border-2 border-amber-200/50 rounded-xl focus:outline-none focus:ring-4 focus:ring-[#BDA78B]/20 focus:border-[#BDA78B] transition-all duration-200 bg-white/50 backdrop-blur-sm file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:bg-gradient-to-r file:from-[#BDA78B] file:to-[#A68B74] file:text-white file:font-medium hover:file:shadow-lg file:transition-all file:duration-200"/>
          </div>
        </div>
        
        <div class="space-y-5">
          <div>
            <label class="block text-sm font-semibold text-[#6B5B47] mb-2">Description</label>
            <textarea name="description" id="product_description" placeholder="Product description..." 
                      class="w-full p-4 border-2 border-amber-200/50 rounded-xl h-32 resize-none focus:outline-none focus:ring-4 focus:ring-[#BDA78B]/20 focus:border-[#BDA78B] transition-all duration-200 bg-white/50 backdrop-blur-sm font-medium text-[#6B5B47] placeholder-amber-400/70 transform focus:scale-[1.02]"></textarea>
          </div>
          
          <div id="current_product_image_preview" class="hidden">
            <label class="block text-sm font-semibold text-[#6B5B47] mb-2">Current Image</label>
            <div class="p-4 bg-gradient-to-r from-amber-100/50 to-orange-100/50 rounded-xl border border-amber-200/50">
              <img id="current_product_image" src="" alt="Current product image" class="w-24 h-24 object-cover rounded-xl shadow-lg mx-auto">
            </div>
          </div>
          
          <div class="space-y-4">
            <div class="flex items-center gap-4">
              <label class="flex items-center gap-3 cursor-pointer group">
                <input type="checkbox" name="is_available" id="product_available" checked class="w-5 h-5 text-[#BDA78B] border-2 border-amber-300 rounded focus:ring-[#BDA78B] focus:ring-2 transition-all duration-200"/> 
                <span class="text-[#6B5B47] font-medium group-hover:text-[#BDA78B] transition-colors duration-200">Available</span>
              </label>
              <label class="flex items-center gap-3 cursor-pointer group">
                <input type="checkbox" name="is_featured" id="product_featured" class="w-5 h-5 text-[#BDA78B] border-2 border-amber-300 rounded focus:ring-[#BDA78B] focus:ring-2 transition-all duration-200"/> 
                <span class="text-[#6B5B47] font-medium group-hover:text-[#BDA78B] transition-colors duration-200">Featured</span>
              </label>
            </div>
          </div>
        </div>
      </div>
      
      <div class="flex justify-end gap-3 mt-8">
        <button type="button" id="closeProduct" class="px-6 py-3 text-[#6B5B47] hover:bg-amber-100/50 rounded-xl transition-all duration-200 font-medium hover:scale-105">
          Cancel
        </button>
        <button type="submit" id="submitProduct" class="px-8 py-3 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium">
          Create
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Logout Button -->
<div class="fixed top-6 right-6 z-40">
  <button class="logout-btn px-6 py-3 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200 font-medium backdrop-blur-md"
          onclick="window.location.href='{% url 'accounts:logout' %}'">
    <svg class="w-4 h-4 inline mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path>
    </svg>
    Logout
  </button>
</div>

<script>
const modalCategory = document.getElementById("modalCategory");
const modalProduct = document.getElementById("modalProduct");
const openAddCategory = document.getElementById("openAddCategory");
const closeCategory = document.getElementById("closeCategory");
const openAddProduct = document.getElementById("openAddProduct");
const closeProduct = document.getElementById("closeProduct");
const categoriesList = document.getElementById("categoriesList");
const productCategoryInput = document.getElementById("product_category_id");
const productsHeading = document.getElementById("productsHeading");
const productsGrid = document.getElementById("productsGrid");
const loadingOverlay = document.getElementById("loadingOverlay");

let selectedCategoryId = null;
let editingCategoryId = null;
let editingProductId = null;

// Utility functions
function showLoading() {
  loadingOverlay.classList.remove("hidden");
}

function hideLoading() {
  loadingOverlay.classList.add("hidden");
}

function showModal(modal) {
  modal.classList.remove("hidden");
  setTimeout(() => {
    const content = modal.querySelector('.modal-content');
    content.style.transform = 'scale(1)';
    content.style.opacity = '1';
  }, 10);
}

function hideModal(modal) {
  const content = modal.querySelector('.modal-content');
  content.style.transform = 'scale(0.95)';
  content.style.opacity = '0';
  setTimeout(() => {
    modal.classList.add("hidden");
  }, 300);
}

// Initialize animations on page load
document.addEventListener('DOMContentLoaded', () => {
  // Animate panels on load
  const panels = document.querySelectorAll('.category-panel, .products-panel');
  panels.forEach((panel, index) => {
    panel.style.opacity = '0';
    panel.style.transform = 'translateY(20px)';
    setTimeout(() => {
      panel.style.transition = 'all 0.6s ease-out';
      panel.style.opacity = '1';
      panel.style.transform = 'translateY(0)';
    }, index * 200);
  });

  // Animate category items
  const categoryItems = document.querySelectorAll('.category-item');
  categoryItems.forEach((item, index) => {
    setTimeout(() => {
      item.style.opacity = '1';
      item.style.transform = 'translateY(0)';
    }, (index * 100) + 800);
  });
});

// Modal handling with animations
openAddCategory.addEventListener("click", () => {
  resetCategoryForm();
  document.getElementById("categoryModalTitle").textContent = "Add Category";
  document.getElementById("submitCategory").textContent = "Create";
  showModal(modalCategory);
});

closeCategory.addEventListener("click", () => hideModal(modalCategory));

openAddProduct.addEventListener("click", () => {
  if (!selectedCategoryId) return;
  resetProductForm();
  productCategoryInput.value = selectedCategoryId;
  document.getElementById("productModalTitle").textContent = "Add Product";
  document.getElementById("submitProduct").textContent = "Create";
  showModal(modalProduct);
});

closeProduct.addEventListener("click", () => hideModal(modalProduct));

// Keyboard support
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    if (!modalCategory.classList.contains('hidden')) {
      hideModal(modalCategory);
    }
    if (!modalProduct.classList.contains('hidden')) {
      hideModal(modalProduct);
    }
  }
});

// Reset forms
function resetCategoryForm() {
  document.getElementById("formCategory").reset();
  document.getElementById("category_id").value = "";
  document.getElementById("current_image_preview").classList.add("hidden");
  document.getElementById("categoryFormSpinner").classList.add("hidden");
  editingCategoryId = null;
}

function resetProductForm() {
  document.getElementById("formProduct").reset();
  document.getElementById("product_id").value = "";
  document.getElementById("current_product_image_preview").classList.add("hidden");
  document.getElementById("productFormSpinner").classList.add("hidden");
  document.getElementById("product_available").checked = true;
  document.getElementById("product_featured").checked = false;
  editingProductId = null;
}

// Category selection and editing
categoriesList.addEventListener("click", async (e) => {
  if (e.target.classList.contains("edit-category-btn")) {
    const catId = e.target.dataset.catId;
    const catName = e.target.dataset.catName;
    
    editingCategoryId = catId;
    document.getElementById("category_id").value = catId;
    document.getElementById("category_name").value = catName;
    document.getElementById("categoryModalTitle").textContent = "Edit Category";
    document.getElementById("submitCategory").textContent = "Update";
    
    showModal(modalCategory);
    return;
  }
  
  // Category selection logic
  const btn = e.target.closest("button[data-cat-id]");
  if (!btn || btn.classList.contains("edit-category-btn")) return;
  
  // Show loading
  showLoading();
  
  // Remove active state from all categories
  document.querySelectorAll('.category-btn').forEach(b => {
    b.classList.remove('bg-gradient-to-r', 'from-[#BDA78B]', 'to-[#A68B74]', 'text-white', 'shadow-lg');
    b.classList.add('hover:bg-gradient-to-r', 'hover:from-amber-50', 'hover:to-orange-50');
  });
  
  // Add active state to selected category
  btn.classList.add('bg-gradient-to-r', 'from-[#BDA78B]', 'to-[#A68B74]', 'text-white', 'shadow-lg');
  btn.classList.remove('hover:bg-gradient-to-r', 'hover:from-amber-50', 'hover:to-orange-50');
  
  selectedCategoryId = btn.dataset.catId;
  productsHeading.innerHTML = `
    <span class="w-2 h-2 bg-gradient-to-r from-[#BDA78B] to-[#A68B74] rounded-full"></span>
    Products — ${btn.textContent}
  `;
  openAddProduct.disabled = false;

  try {
    // Fetch products for this category
    const res = await fetch(`/adminpanel/category/${selectedCategoryId}/products/`);
    const data = await res.json();
    productsGrid.innerHTML = "";
    
    if (data.products.length === 0) {
      productsGrid.innerHTML = `
        <div class="col-span-full text-center py-12">
          <div class="w-20 h-20 bg-gradient-to-r from-amber-200 to-orange-200 rounded-full flex items-center justify-center mx-auto mb-4">
            <svg class="w-10 h-10 text-[#8B7355]" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
            </svg>
          </div>
          <p class="text-[#8B7355] text-lg">No products in ${btn.textContent}</p>
          <p class="text-amber-500/70 text-sm mt-2">Add your first product to get started!</p>
        </div>
      `;
    } else {
      data.products.forEach((p, index) => {
        const div = document.createElement("div");
        div.className = "product-card border-2 border-amber-200/50 rounded-2xl p-5 bg-white/60 backdrop-blur-sm shadow-lg hover:shadow-xl transition-all duration-300 transform hover:scale-[1.02] hover:border-[#BDA78B]/50 opacity-0";
        div.style.animationDelay = `${index * 100}ms`;
        div.innerHTML = `
          <div class="relative h-48 bg-gradient-to-br from-amber-100/50 to-orange-100/50 mb-4 rounded-xl overflow-hidden group">
            <img src="${p.image_url}" alt="${p.name}" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-110"/>
            <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent opacity-0 group-hover:opacity-100 transition-opacity duration-300"></div>
          </div>
          <div class="space-y-3">
            <div class="font-bold text-[#6B5B47] text-lg">${p.name}</div>
            <div class="text-2xl font-bold bg-gradient-to-r from-green-600 to-green-700 bg-clip-text text-transparent">₹${p.price}</div>
            
            <div class="flex items-center gap-4 py-2">
              <label class="flex items-center gap-2 cursor-pointer group">
                <input type="checkbox" data-id="${p.id}" data-field="is_available" ${p.is_available ? "checked" : ""} class="toggle-checkbox w-4 h-4 text-[#BDA78B] border-2 border-amber-300 rounded focus:ring-[#BDA78B] focus:ring-2 transition-all duration-200"/> 
                <span class="text-sm font-medium text-[#6B5B47] group-hover:text-[#BDA78B] transition-colors duration-200">Available</span>
              </label>
              <label class="flex items-center gap-2 cursor-pointer group">
                <input type="checkbox" data-id="${p.id}" data-field="is_featured" ${p.is_featured ? "checked" : ""} class="toggle-checkbox w-4 h-4 text-[#BDA78B] border-2 border-amber-300 rounded focus:ring-[#BDA78B] focus:ring-2 transition-all duration-200"/> 
                <span class="text-sm font-medium text-[#6B5B47] group-hover:text-[#BDA78B] transition-colors duration-200">Featured</span>
              </label>
            </div>
            
            <div class="flex gap-2 pt-2">
              <button data-id="${p.id}" class="edit-product-btn flex-1 px-4 py-2 bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                </svg>
                Edit
              </button>
              <button data-id="${p.id}" class="delete-product-btn px-4 py-2 bg-gradient-to-r from-red-500 to-red-600 text-white rounded-xl hover:shadow-lg transform hover:scale-105 transition-all duration-200 text-sm font-medium">
                <svg class="w-4 h-4 inline mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                </svg>
                Delete
              </button>
            </div>
          </div>
        `;
        productsGrid.appendChild(div);
        
        // Animate product card in
        setTimeout(() => {
          div.style.opacity = '1';
          div.style.transform = 'translateY(0)';
          div.style.transition = 'all 0.5s ease-out';
        }, index * 100);
      });
    }
  } catch (error) {
    console.error('Error loading products:', error);
    productsGrid.innerHTML = `
      <div class="col-span-full text-center py-8">
        <p class="text-red-500">Error loading products. Please try again.</p>
      </div>
    `;
  } finally {
    hideLoading();
  }
});

// Handle product actions
productsGrid.addEventListener("click", async (e) => {
  const productId = e.target.dataset.id || e.target.closest('button')?.dataset.id;
  
  if (e.target.classList.contains("edit-product-btn") || e.target.closest('.edit-product-btn')) {
    await editProduct(productId);
  } else if (e.target.classList.contains("delete-product-btn") || e.target.closest('.delete-product-btn')) {
    if (confirm("Are you sure you want to delete this product?")) {
      showLoading();
      await deleteProduct(productId);
      hideLoading();
    }
  }
});

// Handle checkbox toggles with visual feedback
productsGrid.addEventListener("change", async (e) => {
  if (e.target.classList.contains("toggle-checkbox")) {
    const productId = e.target.dataset.id;
    const field = e.target.dataset.field;
    const value = e.target.checked;
    
    // Add visual feedback
    const label = e.target.closest('label');
    label.style.opacity = '0.5';
    
    const formData = new FormData();
    formData.append('field', field);
    formData.append('value', value);
    formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
    
    try {
      const res = await fetch(`/adminpanel/product/${productId}/toggle/`, {
        method: "POST",
        body: formData
      });
      
      const data = await res.json();
      if (!data.ok) {
        alert("Error updating product");
        e.target.checked = !value; // Revert on error
      }
    } catch (error) {
      alert("Error updating product");
      e.target.checked = !value;
    } finally {
      label.style.opacity = '1';
    }
  }
});

// Edit product function with loading state
async function editProduct(productId) {
  showLoading();
  try {
    const res = await fetch(`/adminpanel/product/${productId}/`);
    const data = await res.json();
    
    if (data.ok) {
      const product = data.product;
      editingProductId = productId;
      
      document.getElementById("product_id").value = productId;
      document.getElementById("product_name").value = product.name;
      document.getElementById("product_description").value = product.description || "";
      document.getElementById("product_price").value = product.price;
      document.getElementById("product_available").checked = product.is_available;
      document.getElementById("product_featured").checked = product.is_featured;
      document.getElementById("product_category_id").value = product.category_id;
      
      // Show current image
      if (product.image_url) {
        document.getElementById("current_product_image").src = product.image_url;
        document.getElementById("current_product_image_preview").classList.remove("hidden");
      }
      
      document.getElementById("productModalTitle").textContent = "Edit Product";
      document.getElementById("submitProduct").textContent = "Update";
      showModal(modalProduct);
    }
  } catch (error) {
    alert("Error loading product details");
  } finally {
    hideLoading();
  }
}

// Delete product function
async function deleteProduct(productId) {
  const formData = new FormData();
  formData.append('csrfmiddlewaretoken', document.querySelector('[name=csrfmiddlewaretoken]').value);
  
  try {
    const res = await fetch(`/adminpanel/product/${productId}/delete/`, {
      method: "POST",
      body: formData
    });
    
    const data = await res.json();
    if (data.ok) {
      // Refresh current category products with animation
      if (selectedCategoryId) {
        const activeBtn = document.querySelector('.category-btn.from-\\[\\#BDA78B\\]');
        if (activeBtn) activeBtn.click();
      }
    } else {
      alert("Error deleting product");
    }
  } catch (error) {
    alert("Error deleting product");
  }
}

// AJAX: create/update category with loading state
document.getElementById("formCategory").addEventListener("submit", async function(e) {
  e.preventDefault();
  
  document.getElementById("categoryFormSpinner").classList.remove("hidden");
  document.getElementById("submitCategory").disabled = true;
  
  const formData = new FormData(this);
  
  const url = editingCategoryId ? 
    `/adminpanel/category/${editingCategoryId}/update/` : 
    "{% url 'adminpanel:create_category' %}";
  
  try {
    const res = await fetch(url, { method: "POST", body: formData });
    const data = await res.json();
    
    if (data.ok) {
      if (editingCategoryId) {
        // Update existing category button
        const btn = document.querySelector(`button[data-cat-id="${editingCategoryId}"]`);
        const editBtn = document.querySelector(`button.edit-category-btn[data-cat-id="${editingCategoryId}"]`);
        if (btn) {
          btn.textContent = data.name;
          btn.dataset.catName = data.name;
          editBtn.dataset.catName = data.name;
        }
      } else {
        // Add new category button with animation
        const container = document.createElement("div");
        container.className = "category-item flex items-center gap-3 opacity-0 transform translate-y-4";
        container.innerHTML = `
          <button data-cat-id="${data.id}" 
                  data-cat-name="${data.name}"
                  class="category-btn flex-1 text-left px-4 py-3 border-2 border-amber-200/50 rounded-xl hover:bg-gradient-to-r hover:from-amber-50 hover:to-orange-50 transition-all duration-300 font-medium text-[#6B5B47] hover:border-[#BDA78B]/50 hover:shadow-md transform hover:translate-y-[-2px]">
            ${data.name}
          </button>
          <button data-cat-id="${data.id}" 
                  data-cat-name="${data.name}"
                  class="edit-category-btn p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition-all duration-200 hover:scale-110">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
            </svg>
          </button>
        `;
        
        // Remove "no categories" message if it exists
        const noCategories = categoriesList.querySelector('p');
        if (noCategories) noCategories.remove();
        
        categoriesList.appendChild(container);
        
        // Animate in
        setTimeout(() => {
          container.style.transition = 'all 0.5s ease-out';
          container.style.opacity = '1';
          container.style.transform = 'translateY(0)';
        }, 100);
      }
      
      this.reset();
      hideModal(modalCategory);
    } else {
      alert(JSON.stringify(data.errors));
    }
  } catch (error) {
    alert("Error processing request");
  } finally {
    document.getElementById("categoryFormSpinner").classList.add("hidden");
    document.getElementById("submitCategory").disabled = false;
  }
});

// AJAX: create/update product with loading state
document.getElementById("formProduct").addEventListener("submit", async function(e) {
  e.preventDefault();
  
  document.getElementById("productFormSpinner").classList.remove("hidden");
  document.getElementById("submitProduct").disabled = true;
  
  const formData = new FormData(this);
  
  const url = editingProductId ? 
    `/adminpanel/product/${editingProductId}/update/` : 
    "{% url 'adminpanel:create_product' %}";
  
  try {
    const res = await fetch(url, { method: "POST", body: formData });
    const data = await res.json();
    
    if (data.ok) {
      // Refresh products grid with animation
      const activeBtn = document.querySelector('.category-btn.from-\\[\\#BDA78B\\]');
      if (activeBtn) activeBtn.click();
      
      this.reset();
      hideModal(modalProduct);
    } else {
      alert(JSON.stringify(data.errors));
    }
  } catch (error) {
    alert("Error processing request");
  } finally {
    document.getElementById("productFormSpinner").classList.add("hidden");
    document.getElementById("submitProduct").disabled = false;
  }
});

// Close modals when clicking outside
modalCategory.addEventListener("click", (e) => {
  if (e.target === modalCategory) hideModal(modalCategory);
});

modalProduct.addEventListener("click", (e) => {
  if (e.target === modalProduct) hideModal(modalProduct);
});

// Touch gesture support for mobile
let startY = 0;
let currentY = 0;
let isDragging = false;

function addTouchSupport(modal) {
  const modalContent = modal.querySelector('.modal-content');
  
  modalContent.addEventListener('touchstart', (e) => {
    startY = e.touches[0].clientY;
    isDragging = true;
  });
  
  modalContent.addEventListener('touchmove', (e) => {
    if (!isDragging) return;
    
    currentY = e.touches[0].clientY;
    const deltaY = currentY - startY;
    
    if (deltaY > 0) {
      const translateY = Math.min(deltaY * 0.5, 100);
      modalContent.style.transform = `translateY(${translateY}px) scale(${1 - deltaY * 0.001})`;
    }
  });
  
  modalContent.addEventListener('touchend', (e) => {
    if (!isDragging) return;
    isDragging = false;
    
    const deltaY = currentY - startY;
    
    if (deltaY > 100) {
      hideModal(modal);
    } else {
      modalContent.style.transform = 'translateY(0) scale(1)';
    }
  });
}

// Apply touch support to modals
addTouchSupport(modalCategory);
addTouchSupport(modalProduct);

// Enhance form inputs with focus animations
document.querySelectorAll('input, textarea').forEach(input => {
  input.addEventListener('focus', function() {
    this.style.transform = 'scale(1.02)';
    this.style.boxShadow = '0 8px 32px rgba(189, 167, 139, 0.15)';
  });
  
  input.addEventListener('blur', function() {
    this.style.transform = 'scale(1)';
    this.style.boxShadow = 'none';
  });
});
</script>

<style>
/* Custom keyframe animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUp {
  from {
    transform: translateY(100px) scale(0.95);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

@keyframes pulse {
  0%, 100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}

@keyframes spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

/* Animation classes */
.animate-fadeInUp {
  animation: fadeInUp 0.6s ease-out forwards;
}

.animate-slideUp {
  animation: slideUp 0.4s ease-out forwards;
}

.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

.animate-spin {
  animation: spin 1s linear infinite;
}

/* Global styles */
* {
  box-sizing: border-box;
}

body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
  background: linear-gradient(135deg, #FEF7ED 0%, #FED7AA 50%, #FDBA74 100%);
  min-height: 100vh;
}

/* Enhanced button styles */
button {
  font-weight: 500;
  letter-spacing: 0.025em;
}

/* Category button active state */
.category-btn.from-\[#BDA78B\] {
  background: linear-gradient(to right, #BDA78B, #A68B74) !important;
  color: white !important;
  box-shadow: 0 10px 25px rgba(189, 167, 139, 0.3) !important;
  border-color: transparent !important;
}

/* Product cards hover effects */
.product-card {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.product-card:hover {
  transform: translateY(-8px) scale(1.02);
  box-shadow: 0 25px 50px rgba(189, 167, 139, 0.25);
}

/* Modal enhancements */
.modal-content {
  backdrop-filter: blur(20px);
  background: rgba(255, 255, 255, 0.95);
  border: 1px solid rgba(251, 191, 36, 0.2);
}

/* Loading spinner styles */
.spinner {
  border: 3px solid rgba(189, 167, 139, 0.3);
  border-top: 3px solid #BDA78B;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  animation: spin 1s linear infinite;
}

/* Custom scrollbar */
::-webkit-scrollbar {
  width: 8px;
}

::-webkit-scrollbar-track {
  background: rgba(251, 191, 36, 0.1);
  border-radius: 10px;
}

::-webkit-scrollbar-thumb {
  background: linear-gradient(to bottom, #BDA78B, #A68B74);
  border-radius: 10px;
  border: 2px solid transparent;
  background-clip: padding-box;
}

::-webkit-scrollbar-thumb:hover {
  background: linear-gradient(to bottom, #A68B74, #8B7355);
}

/* Glass effect utilities */
.glass {
  background: rgba(255, 255, 255, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.2);
}

.glass-brown {
  background: rgba(189, 167, 139, 0.1);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(189, 167, 139, 0.2);
}

/* Enhanced focus styles */
input:focus, textarea:focus, select:focus {
  outline: none;
  ring: 4px;
  ring-color: rgba(189, 167, 139, 0.2);
  border-color: #BDA78B;
  box-shadow: 0 0 0 4px rgba(189, 167, 139, 0.1);
}

/* Button hover effects */
button:not(:disabled):hover {
  filter: brightness(1.05);
}

/* Mobile optimizations */
@media (max-width: 768px) {
  .modal-content {
    margin: 1rem;
    max-height: calc(100vh - 2rem);
    border-radius: 24px;
  }
  
  .container {
    padding: 1rem;
  }
  
  .grid {
    gap: 1rem;
  }
  
  /* Larger touch targets */
  button {
    min-height: 44px;
    padding: 12px 16px;
  }
  
  input, textarea {
    padding: 16px;
    font-size: 16px; /* Prevents zoom on iOS */
  }
  
  /* Full-screen modals on small screens */
  @media (max-height: 600px) {
    .modal-content {
      max-height: 100vh;
      margin: 0;
      border-radius: 0;
    }
  }
}

/* High contrast mode support */
@media (prefers-contrast: high) {
  .border-amber-200\/50 {
    border-color: #BDA78B;
  }
  
  .text-amber-400\/70 {
    color: #8B7355;
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  * {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* Enhanced gradient backgrounds */
.bg-gradient-brown {
  background: linear-gradient(135deg, #BDA78B 0%, #A68B74 50%, #8B7355 100%);
}

.bg-gradient-brown-light {
  background: linear-gradient(135deg, #F3E8DC 0%, #E6D3C1 50%, #D4C0A6 100%);
}

/* Glow effects */
.glow-brown {
  box-shadow: 0 0 20px rgba(189, 167, 139, 0.4);
}

.glow-brown-intense {
  box-shadow: 0 0 30px rgba(189, 167, 139, 0.6);
}

/* Enhanced checkbox styles */
input[type="checkbox"]:checked {
  background-color: #BDA78B;
  border-color: #BDA78B;
}

input[type="checkbox"]:focus {
  ring-color: rgba(189, 167, 139, 0.5);
}

/* Product card image overlay */
.product-card .image-overlay {
  background: linear-gradient(
    45deg,
    rgba(189, 167, 139, 0.1) 0%,
    rgba(189, 167, 139, 0.05) 50%,
    transparent 100%
  );
}

/* Form validation styles */
input:invalid:not(:focus) {
  border-color: #EF4444;
  ring-color: rgba(239, 68, 68, 0.2);
}

input:valid {
  border-color: #22C55E;
}

/* Loading states */
.loading {
  position: relative;
  overflow: hidden;
}

.loading::after {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(
    90deg,
    transparent,
    rgba(189, 167, 139, 0.2),
    transparent
  );
  animation: shimmer 2s infinite;
}

@keyframes shimmer {
  0% {
    left: -100%;
  }
  100% {
    left: 100%;
  }
}

/* Success state animations */
.success-bounce {
  animation: successBounce 0.6s ease-out;
}

@keyframes successBounce {
  0%, 20%, 53%, 80%, 100% {
    transform: scale(1);
  }
  40%, 43% {
    transform: scale(1.05);
  }
  70% {
    transform: scale(1.02);
  }
  90% {
    transform: scale(1.01);
  }
}

/* Enhanced logout button */
.logout-btn {
  backdrop-filter: blur(10px);
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
}

/* Smooth transitions for all elements */
* {
  transition-property: color, background-color, border-color, text-decoration-color, fill, stroke, opacity, box-shadow, transform, filter, backdrop-filter;
  transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
  transition-duration: 200ms;
}

/* Enhanced glass morphism */
.glass-morphism {
  background: rgba(255, 255, 255, 0.25);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.18);
  box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
}

.glass-morphism-brown {
  background: rgba(189, 167, 139, 0.15);
  backdrop-filter: blur(20px);
  border: 1px solid rgba(189, 167, 139, 0.2);
  box-shadow: 0 8px 32px rgba(189, 167, 139, 0.2);
}
</style>
{% endblock %}