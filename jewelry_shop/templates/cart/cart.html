{% extends "core/base.html" %}
{% block content %}

<main class="px-4 sm:px-6 md:px-10 lg:px-20 xl:px-40 flex flex-1 justify-center py-6 sm:py-12">
  <div class="layout-content-container flex flex-col w-full max-w-5xl">
    <h2 class="text-stone-800 text-2xl sm:text-3xl lg:text-4xl font-bold tracking-tight mb-6 sm:mb-8">Shopping Cart</h2>

    <div class="flex flex-col lg:grid lg:grid-cols-3 gap-6 lg:gap-12">
      <!-- Cart Items -->
      <div class="lg:col-span-2 space-y-4 sm:space-y-6" id="cart-items">
        {% for item in cart.items.all %}
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 cart-item" id="item-{{ item.id }}" data-item-id="{{ item.id }}">
          <!-- Mobile Layout -->
          <div class="flex flex-col sm:hidden space-y-4">
            <div class="flex items-start gap-4">
              <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md size-16 flex-shrink-0"
                   style='background-image: url("{{ item.product.image.url }}");'></div>
              <div class="flex-1 min-w-0">
                <p class="text-stone-800 text-base font-semibold truncate">{{ item.product.name }}</p>
                <p class="text-stone-500 text-sm">₹{{ item.product.price }}</p>
              </div>
              <button class="remove-item text-stone-400 hover:text-red-500 transition-colors p-2 -mt-2" 
                      data-item-id="{{ item.id }}" 
                      data-product-id="{{ item.product.id }}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2 text-stone-800 border border-stone-200 rounded-md px-3 py-2">
                <button class="decrease-qty hover:bg-stone-100 w-8 h-8 flex items-center justify-center rounded transition-colors" 
                        data-item-id="{{ item.id }}" 
                        data-product-id="{{ item.product.id }}">-</button>
                <input type="number" value="{{ item.quantity }}" 
                       class="w-12 text-center bg-transparent border-none outline-none text-sm" 
                       readonly id="qty-{{ item.id }}">
                <button class="increase-qty hover:bg-stone-100 w-8 h-8 flex items-center justify-center rounded transition-colors" 
                        data-item-id="{{ item.id }}" 
                        data-product-id="{{ item.product.id }}">+</button>
              </div>
              <p class="text-stone-800 font-medium text-lg">₹<span id="item-total-{{ item.id }}">{{ item.total_price }}</span></p>
            </div>
          </div>

          <!-- Desktop Layout -->
          <div class="hidden sm:flex items-center justify-between">
            <div class="flex items-center gap-4 md:gap-6">
              <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md size-20 md:size-24 flex-shrink-0"
                   style='background-image: url("{{ item.product.image.url }}");'></div>
              <div class="flex flex-col justify-center min-w-0">
                <p class="text-stone-800 text-lg font-semibold truncate">{{ item.product.name }}</p>
                <p class="text-stone-500 text-base">₹{{ item.product.price }}</p>
              </div>
            </div>
            <div class="flex items-center gap-3 md:gap-4 flex-shrink-0">
              <div class="flex items-center gap-2 text-stone-800 border border-stone-200 rounded-md px-2">
                <button class="decrease-qty hover:bg-stone-100 px-2 py-1 rounded transition-colors" 
                        data-item-id="{{ item.id }}" 
                        data-product-id="{{ item.product.id }}">-</button>
                <input type="number" value="{{ item.quantity }}" 
                       class="w-12 text-center bg-transparent border-none outline-none" 
                       readonly id="qty-{{ item.id }}">
                <button class="increase-qty hover:bg-stone-100 px-2 py-1 rounded transition-colors" 
                        data-item-id="{{ item.id }}" 
                        data-product-id="{{ item.product.id }}">+</button>
              </div>
              <p class="text-stone-800 font-medium min-w-20">₹<span id="item-total-{{ item.id }}">{{ item.total_price }}</span></p>
              <button class="remove-item text-stone-400 hover:text-red-500 transition-colors px-2 py-1 rounded whitespace-nowrap" 
                      data-item-id="{{ item.id }}" 
                      data-product-id="{{ item.product.id }}">Remove</button>
            </div>
          </div>
        </div>
        {% empty %}
        <div id="empty-cart-message" class="text-gray-500 text-center py-12">
          <p class="text-lg sm:text-xl">Your cart is empty.</p>
          <a href="#" class="inline-block mt-4 text-stone-800 hover:text-stone-600 underline">Continue Shopping</a>
        </div>
        {% endfor %}
      </div>

      <!-- Order Summary -->
      <div class="lg:col-span-1 order-first lg:order-last">
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 lg:sticky lg:top-12" id="order-summary">
          <h3 class="text-stone-800 text-lg sm:text-xl font-bold mb-4">Order Summary</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-500 text-sm sm:text-base">Items (<span id="total-items">{{ cart.total_items }}</span>)</p>
              <p class="text-stone-800 text-sm sm:text-base font-medium">₹<span id="subtotal">{{ cart.total_price }}</span></p>
            </div>
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-500 text-sm sm:text-base">Shipping</p>
              <p class="text-stone-800 text-sm sm:text-base font-medium">Free</p>
            </div>
            <div class="border-t border-stone-200 my-4"></div>
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-800 text-base sm:text-lg font-bold">Total</p>
              <p class="text-stone-800 text-base sm:text-lg font-bold">₹<span id="total">{{ cart.total_price }}</span></p>
            </div>
          </div>
          <button id="checkout-btn" class="w-full mt-6 flex items-center justify-center rounded-md h-12 sm:h-14 bg-stone-800 hover:bg-stone-900 transition-colors text-white text-sm sm:text-base font-bold disabled:bg-gray-400 disabled:cursor-not-allowed">
            <span id="checkout-text">Proceed to Checkout</span>
            <span id="checkout-loading" class="hidden">Processing...</span>
          </button>
        </div>
      </div>
    </div>
  </div>
</main>

<!-- Loading Overlay -->
<div id="loading-overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg p-4 sm:p-6 flex items-center gap-3 sm:gap-4 max-w-sm w-full">
    <div class="animate-spin rounded-full h-5 w-5 sm:h-6 sm:w-6 border-b-2 border-stone-800 flex-shrink-0"></div>
    <span class="text-stone-800 text-sm sm:text-base">Updating cart...</span>
  </div>
</div>

<!-- Success/Error Messages -->
<div id="message-container" class="fixed top-4 right-4 z-50 space-y-2"></div>

<script>
let isUpdating = false;
const csrfToken = "{{ csrf_token }}";

function showLoading() { document.getElementById('loading-overlay').classList.remove('hidden'); }
function hideLoading() { document.getElementById('loading-overlay').classList.add('hidden'); }

function showMessage(message, type='success') {
    const container = document.getElementById('message-container');
    const messageDiv = document.createElement('div');
    messageDiv.className = `px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-white text-sm sm:text-base max-w-xs sm:max-w-sm ${type==='success'?'bg-green-500':'bg-red-500'}`;
    messageDiv.textContent = message;
    container.appendChild(messageDiv);
    setTimeout(() => {
        messageDiv.style.opacity = '0';
        messageDiv.style.transform = 'translateX(100%)';
        setTimeout(() => { if(messageDiv.parentNode) messageDiv.remove(); }, 300);
    }, 3000);
}

function formatPrice(price) { return parseFloat(price).toFixed(2); }

function updateCartUI(data) {
    if (!data.removed) {
// Update all matching elements (mobile + desktop)
document.querySelectorAll(`#qty-${data.item_id}`).forEach(el => el.value = data.quantity);
document.querySelectorAll(`#item-total-${data.item_id}`).forEach(el => el.textContent = formatPrice(data.item_total));
    } else {
        const itemElement = document.getElementById(`item-${data.item_id}`);
        itemElement.style.transition='all 0.3s ease';
        itemElement.style.opacity='0';
        itemElement.style.transform='translateX(100%)';
        setTimeout(() => { itemElement.remove(); checkEmptyCart(); }, 300);
    }
    document.getElementById("subtotal").textContent = formatPrice(data.subtotal);
    document.getElementById("total").textContent = formatPrice(data.subtotal);
    document.getElementById("total-items").textContent = data.total_items || 0;

    const checkoutBtn = document.getElementById("checkout-btn");
    if(data.total_items===0) { checkoutBtn.disabled=true; checkoutBtn.classList.add('disabled:bg-gray-400','disabled:cursor-not-allowed'); }
    else { checkoutBtn.disabled=false; checkoutBtn.classList.remove('disabled:bg-gray-400','disabled:cursor-not-allowed'); }
}

function checkEmptyCart() {
    const cartItems = document.getElementById('cart-items');
    const cartItemElements = cartItems.querySelectorAll('.cart-item');
    if(cartItemElements.length===0) {
        cartItems.innerHTML = `
            <div id="empty-cart-message" class="text-gray-500 text-center py-12">
                <p class="text-xl">Your cart is empty.</p>
                <a href="#" class="inline-block mt-4 text-stone-800 hover:text-stone-600 underline">Continue Shopping</a>
            </div>`;
    }
}

function updateCart(itemId, productId, action) {
    if(isUpdating) { showMessage('Please wait, updating cart...', 'error'); return; }
    isUpdating=true; showLoading();

    let change = 0;
    if(action==='increase') change=1;
    else if(action==='decrease') change=-1;
    else if(action==='remove') change=-999;

    fetch("{% url 'cart:update_cart_item' %}", {
        method:"POST",
        headers:{"Content-Type":"application/x-www-form-urlencoded","X-CSRFToken":csrfToken},
        body:`product_id=${productId}&change=${change}`
    })
    .then(resp => { if(!resp.ok) throw new Error(`HTTP ${resp.status}`); return resp.json(); })
    .then(data => {
        hideLoading(); isUpdating=false;
        if(data.success){ data.item_id=itemId; updateCartUI(data);
            if(data.removed) showMessage('Item removed from cart');
            else if(action==='increase') showMessage('Item quantity increased');
            else if(action==='decrease') showMessage('Item quantity decreased');
        } else showMessage('Failed to update cart.', 'error');
    })
    .catch(err => { hideLoading(); isUpdating=false; console.error(err); showMessage('Network error', 'error'); });
}

// Event delegation
document.addEventListener('click', function(e){
    const btn = e.target.closest('.increase-qty, .decrease-qty, .remove-item');
    if(!btn) return;
    const itemId = btn.dataset.itemId;
    const productId = btn.dataset.productId;

    if(btn.classList.contains('increase-qty')) updateCart(itemId, productId, 'increase');
    else if(btn.classList.contains('decrease-qty')) updateCart(itemId, productId, 'decrease');
    else if(btn.classList.contains('remove-item')) {
        if(confirm('Are you sure you want to remove this item?')) updateCart(itemId, productId, 'remove');
    }
});

// Checkout
document.getElementById('checkout-btn').addEventListener('click', function(e){
    if(this.disabled){ e.preventDefault(); showMessage('Your cart is empty','error'); return; }
    showMessage('Redirecting to checkout...','success');
    // Add checkout logic here
});
</script>

<style>
/* Keep all your previous styling for mobile responsiveness, buttons, overlays, transitions etc. */
</style>

{% endblock %}
