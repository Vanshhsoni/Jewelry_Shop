{% extends "core/base.html" %}
{% block content %}

<main class="px-4 sm:px-6 md:px-10 lg:px-20 xl:px-40 flex flex-1 justify-center py-6 sm:py-12">
  <div class="layout-content-container flex flex-col w-full max-w-5xl relative">

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-white bg-opacity-75 z-50 flex items-center justify-center hidden">
      <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-stone-900"></div>
    </div>

    <h2 class="text-stone-800 text-2xl sm:text-3xl lg:text-4xl font-bold tracking-tight mb-6 sm:mb-8">
      Shopping Cart
    </h2>

    <div class="flex flex-col lg:grid lg:grid-cols-3 gap-6 lg:gap-12">
      <!-- Cart Items -->
      <div class="lg:col-span-2 space-y-4 sm:space-y-6" id="cart-items">
        {% for item in cart.items.all %}
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 cart-item flex flex-col sm:flex-row items-center justify-between transition-all duration-300"
             id="item-{{ item.id }}"
             data-item-id="{{ item.id }}"
             data-product-id="{{ item.product.id }}"
             data-price="{{ item.product.price }}">

          <!-- Product Info -->
          <div class="flex items-center gap-4 flex-1 min-w-0">
            <div class="bg-cover bg-center aspect-square w-16 h-16 sm:w-20 sm:h-20 rounded-md flex-shrink-0"
                 style="background-image: url('{{ item.product.image.url }}');"></div>
            <div class="flex flex-col justify-center min-w-0">
              <p class="text-stone-800 text-base sm:text-lg font-semibold truncate">{{ item.product.name }}</p>
              <p class="text-stone-500 text-sm sm:text-base">₹{{ item.product.price }}</p>
            </div>
          </div>

          <!-- Quantity Controls & Remove -->
          <div class="flex items-center gap-3 mt-4 sm:mt-0">
            <div class="flex items-center gap-2 text-stone-800 border border-stone-200 rounded-md px-2 py-1">
              <button class="decrease-qty hover:bg-stone-100 px-2 py-1 rounded transition-colors disabled:opacity-50" 
                      data-item-id="{{ item.id }}" 
                      data-product-id="{{ item.product.id }}">-</button>
              <span class="w-12 text-center font-medium qty-display" data-item-id="{{ item.id }}">{{ item.quantity }}</span>
              <button class="increase-qty hover:bg-stone-100 px-2 py-1 rounded transition-colors disabled:opacity-50" 
                      data-item-id="{{ item.id }}" 
                      data-product-id="{{ item.product.id }}">+</button>
            </div>
            <p class="text-stone-800 font-medium min-w-20">₹<span class="item-total" data-item-id="{{ item.id }}">{{ item.total_price }}</span></p>
            <button class="remove-item text-stone-400 hover:text-red-500 transition-colors px-2 py-1 rounded whitespace-nowrap disabled:opacity-50" 
                    data-item-id="{{ item.id }}" 
                    data-product-id="{{ item.product.id }}">Remove</button>
          </div>

        </div>
        {% empty %}
        <div id="empty-cart-message" class="text-gray-500 text-center py-12">
          <p class="text-lg sm:text-xl">Your cart is empty.</p>
          <a href="{% url 'shop:category' %}" class="inline-block mt-4 text-stone-800 hover:text-stone-600 underline">Continue Shopping</a>
        </div>
        {% endfor %}
      </div>

      <!-- Order Summary -->
      {% if cart.total_items > 0 %}
      <div class="lg:col-span-1 order-first lg:order-last" id="order-summary-container"> 
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 lg:sticky lg:top-12" id="order-summary">
          <h3 class="text-stone-800 text-lg sm:text-xl font-bold mb-4">Order Summary</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-500 text-sm sm:text-base">Items (<span id="total-items">{{ cart.total_items }}</span>)</p>
              <p class="text-stone-800 text-sm sm:text-base font-medium">₹<span id="subtotal">{{ cart.total_price }}</span></p>
            </div>
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-500 text-sm sm:text-base">Shipping</p>
              <p class="text-stone-800 text-sm sm:text-base font-medium">Free</p>
            </div>
            <div class="border-t border-stone-200 my-4"></div>
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-800 text-base sm:text-lg font-bold">Total</p>
              <p class="text-stone-800 text-base sm:text-lg font-bold">₹<span id="total">{{ cart.total_price }}</span></p>
            </div>
          </div>
          <button id="checkout-btn" class="w-full mt-6 flex items-center justify-center rounded-md h-12 sm:h-14 bg-stone-800 hover:bg-stone-900 transition-colors text-white text-sm sm:text-base font-bold disabled:bg-gray-400 disabled:cursor-not-allowed">
            <span id="checkout-text">Proceed to Checkout</span>
            <span id="checkout-loading" class="hidden">Processing...</span>
          </button>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</main>

<script>
class LiveCart {
    constructor() {
        this.csrfToken = "{{ csrf_token }}";
        this.pendingUpdates = new Map();
        this.debounceTimers = new Map();
        this.loadingOverlay = document.getElementById('loading-overlay'); 
        this.init();
    }

    init() {
        document.addEventListener('click', e => this.handleClick(e));
        const checkoutBtn = document.getElementById('checkout-btn');
        if (checkoutBtn) checkoutBtn.addEventListener('click', () => window.location.href = "{% url 'orders:checkout' %}");
    }

    showLoader() { this.loadingOverlay.classList.remove('hidden'); }
    hideLoader() { this.loadingOverlay.classList.add('hidden'); }

    handleClick(e) {
        const btn = e.target.closest('.increase-qty, .decrease-qty, .remove-item');
        if (!btn) return;
        e.preventDefault();
        const { itemId, productId } = btn.dataset;
        if (btn.classList.contains('increase-qty')) this.updateQuantity(itemId, productId, 1);
        else if (btn.classList.contains('decrease-qty')) this.updateQuantity(itemId, productId, -1);
        else if (btn.classList.contains('remove-item')) this.removeItem(itemId, productId);
    }

    updateQuantity(itemId, productId, change) {
        const qtyDisplay = document.querySelector(`.qty-display[data-item-id="${itemId}"]`);
        if (!qtyDisplay) return;
        let currentQty = parseInt(qtyDisplay.textContent) || 0;
        let newQty = Math.max(0, currentQty + change);
        if (newQty === 0 && change < 0) { this.removeItem(itemId, productId); return; }
        this.updateItemDisplay(itemId, newQty);
        const currentPending = this.pendingUpdates.get(itemId) || 0;
        this.pendingUpdates.set(itemId, currentPending + change);
        if (this.debounceTimers.has(itemId)) clearTimeout(this.debounceTimers.get(itemId));
        this.debounceTimers.set(itemId, setTimeout(() => this.flushPendingUpdate(itemId, productId), 500));
    }

    async flushPendingUpdate(itemId, productId) {
        const total_change = this.pendingUpdates.get(itemId);
        if (!total_change) return;
        this.pendingUpdates.delete(itemId);
        this.showLoader();
        try {
            const res = await fetch("{% url 'cart:batch_update_cart' %}", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": this.csrfToken },
                body: `product_id=${productId}&total_change=${total_change}`
            });
            const data = await res.json();
            if (data.success) {
                if (data.quantity <= 0) this.removeItemFromDOM(itemId);
                else this.updateItemDisplay(itemId, data.quantity);
                this.updateCartTotals(data.total_items, data.total_price);
            }
        } catch(err) { console.error(err); }
        finally { this.hideLoader(); }
    }

    async removeItem(itemId, productId) {
        this.showLoader();
        this.removeItemFromDOM(itemId);
        try {
            const res = await fetch("{% url 'cart:remove_from_cart' %}", {
                method: "POST",
                headers: { "Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": this.csrfToken },
                body: `product_id=${productId}`
            });
            const data = await res.json();
            if (data.success) this.updateCartTotals(data.total_items, data.total_price);
        } catch(err) { console.error(err); }
        finally { this.hideLoader(); }
    }

    removeItemFromDOM(itemId) {
        const el = document.getElementById(`item-${itemId}`);
        if (!el) return;
        el.style.opacity = '0';
        el.style.transform = 'translateX(100%)';
        setTimeout(() => {
            el.remove();
            this.checkEmptyCart();
        }, 300);
    }

    updateItemDisplay(itemId, quantity) {
        document.querySelectorAll(`.qty-display[data-item-id="${itemId}"]`).forEach(el => el.textContent = quantity);
        const itemEl = document.getElementById(`item-${itemId}`);
        if (!itemEl) return;
        const price = parseFloat(itemEl.dataset.price);
        document.querySelectorAll(`.item-total[data-item-id="${itemId}"]`).forEach(el => {
            el.textContent = (quantity * price).toFixed(2);
        });
    }

    updateCartTotals(totalItems, totalPrice) {
        const subtotalEl = document.getElementById('subtotal');
        const totalEl = document.getElementById('total');
        const totalItemsEl = document.getElementById('total-items');
        if(subtotalEl && totalEl && totalItemsEl){
            subtotalEl.textContent = parseFloat(totalPrice).toFixed(2);
            totalEl.textContent = parseFloat(totalPrice).toFixed(2);
            totalItemsEl.textContent = totalItems;
        }
        const checkoutBtn = document.getElementById('checkout-btn');
        if (checkoutBtn) checkoutBtn.disabled = totalItems === 0;
    }

    checkEmptyCart() {
        const cartItemsContainer = document.getElementById('cart-items');
        if (cartItemsContainer.querySelectorAll('.cart-item').length === 0) {
            const orderSummary = document.getElementById('order-summary-container');
            if (orderSummary) orderSummary.remove();
            cartItemsContainer.innerHTML = `
                <div id="empty-cart-message" class="text-gray-500 text-center py-12">
                    <p class="text-lg sm:text-xl">Your cart is empty.</p>
                    <a href="{% url 'shop:category' %}" class="inline-block mt-4 text-stone-800 hover:text-stone-600 underline">Continue Shopping</a>
                </div>`;
        }
    }
}

document.addEventListener('DOMContentLoaded', () => new LiveCart());
</script>

<style>
.cart-item {
    transform: translateX(0);
    opacity: 1;
    transition: all 0.3s ease-in-out;
}
.hidden { display: none; }
</style>

{% endblock %}
