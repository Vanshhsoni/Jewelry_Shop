{% extends "core/base.html" %}
{% block content %}

<main class="px-4 sm:px-6 md:px-10 lg:px-20 xl:px-40 flex flex-1 justify-center py-6 sm:py-12">
  <div class="layout-content-container flex flex-col w-full max-w-5xl">
    <h2 class="text-stone-800 text-2xl sm:text-3xl lg:text-4xl font-bold tracking-tight mb-6 sm:mb-8">Shopping Cart</h2>

    <div class="flex flex-col lg:grid lg:grid-cols-3 gap-6 lg:gap-12">
      <!-- Cart Items -->
      <div class="lg:col-span-2 space-y-4 sm:space-y-6" id="cart-items">
        {% for item in cart.items.all %}
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 cart-item transition-all duration-300" 
             id="item-{{ item.id }}" 
             data-item-id="{{ item.id }}"
             data-product-id="{{ item.product.id }}"
             data-price="{{ item.product.price }}">
          
          <!-- Mobile Layout -->
          <div class="flex flex-col sm:hidden space-y-4">
            <div class="flex items-start gap-4">
              <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md size-16 flex-shrink-0"
                   style='background-image: url("{{ item.product.image.url }}");'></div>
              <div class="flex-1 min-w-0">
                <p class="text-stone-800 text-base font-semibold truncate">{{ item.product.name }}</p>
                <p class="text-stone-500 text-sm">₹{{ item.product.price }}</p>
              </div>
              <button class="remove-item text-stone-400 hover:text-red-500 transition-colors p-2 -mt-2 disabled:opacity-50" 
                      data-item-id="{{ item.id }}" 
                      data-product-id="{{ item.product.id }}">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                </svg>
              </button>
            </div>
            <div class="flex items-center justify-between">
              <div class="flex items-center gap-2 text-stone-800 border border-stone-200 rounded-md px-3 py-2">
                <button class="decrease-qty hover:bg-stone-100 w-8 h-8 flex items-center justify-center rounded transition-colors disabled:opacity-50" 
                        data-item-id="{{ item.id }}" 
                        data-product-id="{{ item.product.id }}">-</button>
                <span class="w-12 text-center text-sm font-medium qty-display" data-item-id="{{ item.id }}">{{ item.quantity }}</span>
                <button class="increase-qty hover:bg-stone-100 w-8 h-8 flex items-center justify-center rounded transition-colors disabled:opacity-50" 
                        data-item-id="{{ item.id }}" 
                        data-product-id="{{ item.product.id }}">+</button>
              </div>
              <p class="text-stone-800 font-medium text-lg">₹<span class="item-total" data-item-id="{{ item.id }}">{{ item.total_price }}</span></p>
            </div>
          </div>

          <!-- Desktop Layout -->
          <div class="hidden sm:flex items-center justify-between">
            <div class="flex items-center gap-4 md:gap-6">
              <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-md size-20 md:size-24 flex-shrink-0"
                   style='background-image: url("{{ item.product.image.url }}");'></div>
              <div class="flex flex-col justify-center min-w-0">
                <p class="text-stone-800 text-lg font-semibold truncate">{{ item.product.name }}</p>
                <p class="text-stone-500 text-base">₹{{ item.product.price }}</p>
              </div>
            </div>
            <div class="flex items-center gap-3 md:gap-4 flex-shrink-0">
              <div class="flex items-center gap-2 text-stone-800 border border-stone-200 rounded-md px-2">
                <button class="decrease-qty hover:bg-stone-100 px-2 py-1 rounded transition-colors disabled:opacity-50" 
                        data-item-id="{{ item.id }}" 
                        data-product-id="{{ item.product.id }}">-</button>
                <span class="w-12 text-center font-medium qty-display" data-item-id="{{ item.id }}">{{ item.quantity }}</span>
                <button class="increase-qty hover:bg-stone-100 px-2 py-1 rounded transition-colors disabled:opacity-50" 
                        data-item-id="{{ item.id }}" 
                        data-product-id="{{ item.product.id }}">+</button>
              </div>
              <p class="text-stone-800 font-medium min-w-20">₹<span class="item-total" data-item-id="{{ item.id }}">{{ item.total_price }}</span></p>
              <button class="remove-item text-stone-400 hover:text-red-500 transition-colors px-2 py-1 rounded whitespace-nowrap disabled:opacity-50" 
                      data-item-id="{{ item.id }}" 
                      data-product-id="{{ item.product.id }}">Remove</button>
            </div>
          </div>
        </div>
        {% empty %}
        <div id="empty-cart-message" class="text-gray-500 text-center py-12">
          <p class="text-lg sm:text-xl">Your cart is empty.</p>
          <a href="{% url 'shop:category' %}" class="inline-block mt-4 text-stone-800 hover:text-stone-600 underline">Continue Shopping</a>
        </div>
        {% endfor %}
      </div>
      {% if cart.total_items > 0 %}
      <!-- Order Summary -->
      <div class="lg:col-span-1 order-first lg:order-last">
        <div class="bg-white rounded-lg shadow-sm p-4 sm:p-6 lg:sticky lg:top-12" id="order-summary">
          <h3 class="text-stone-800 text-lg sm:text-xl font-bold mb-4">Order Summary</h3>
          <div class="space-y-3">
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-500 text-sm sm:text-base">Items (<span id="total-items">{{ cart.total_items }}</span>)</p>
              <p class="text-stone-800 text-sm sm:text-base font-medium">₹<span id="subtotal">{{ cart.total_price }}</span></p>
            </div>
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-500 text-sm sm:text-base">Shipping</p>
              <p class="text-stone-800 text-sm sm:text-base font-medium">Free</p>
            </div>
            <div class="border-t border-stone-200 my-4"></div>
            <div class="flex justify-between items-center gap-x-4">
              <p class="text-stone-800 text-base sm:text-lg font-bold">Total</p>
              <p class="text-stone-800 text-base sm:text-lg font-bold">₹<span id="total">{{ cart.total_price }}</span></p>
            </div>
          </div>
          <button id="checkout-btn" class="w-full mt-6 flex items-center justify-center rounded-md h-12 sm:h-14 bg-stone-800 hover:bg-stone-900 transition-colors text-white text-sm sm:text-base font-bold disabled:bg-gray-400 disabled:cursor-not-allowed">
            <span id="checkout-text">Proceed to Checkout</span>
            <span id="checkout-loading" class="hidden">Processing...</span>
          </button>
        </div>
      </div>
      {% endif %}
    </div>
  </div>
</main>

<script>
class OptimizedCartManager {
    constructor() {
        this.csrfToken = "{{ csrf_token }}";
        this.pendingUpdates = new Map(); // Track pending updates per item
        this.debounceTimers = new Map(); // Separate timers per item
        this.isGlobalUpdating = false;
        
        this.init();
    }

    init() {
        // Use event delegation for better performance
        document.addEventListener('click', this.handleClick.bind(this));
        
        // Initialize checkout button
        const checkoutBtn = document.getElementById('checkout-btn');
        if (checkoutBtn) {
            checkoutBtn.addEventListener('click', this.handleCheckout.bind(this));
        }
    }

    handleClick(e) {
        const btn = e.target.closest('.increase-qty, .decrease-qty, .remove-item');
        if (!btn) return;

        const itemId = btn.dataset.itemId;
        const productId = btn.dataset.productId;

        if (btn.classList.contains('increase-qty')) {
            this.updateQuantity(itemId, productId, 1);
        } else if (btn.classList.contains('decrease-qty')) {
            this.updateQuantity(itemId, productId, -1);
        } else if (btn.classList.contains('remove-item')) {
            if (confirm('Remove this item from your cart?')) {
                this.removeItem(itemId, productId);
            }
        }
    }

    updateQuantity(itemId, productId, change) {
        if (this.isGlobalUpdating) return;

        // Get current quantity from display
        const qtyDisplay = document.querySelector(`.qty-display[data-item-id="${itemId}"]`);
        if (!qtyDisplay) return;

        let currentQty = parseInt(qtyDisplay.textContent) || 0;
        let newQty = Math.max(0, currentQty + change);

        // Optimistic update - change UI immediately
        this.updateItemDisplay(itemId, newQty);

        // Track pending changes for this item
        if (!this.pendingUpdates.has(itemId)) {
            this.pendingUpdates.set(itemId, 0);
        }
        this.pendingUpdates.set(itemId, this.pendingUpdates.get(itemId) + change);

        // Debounce server call per item
        if (this.debounceTimers.has(itemId)) {
            clearTimeout(this.debounceTimers.get(itemId));
        }

        this.debounceTimers.set(itemId, setTimeout(() => {
            this.flushPendingUpdate(itemId, productId);
        }, 150)); // Faster response time
    }

    updateItemDisplay(itemId, quantity) {
        const itemElement = document.getElementById(`item-${itemId}`);
        if (!itemElement) return;

        const price = parseFloat(itemElement.dataset.price);
        const itemTotal = (quantity * price).toFixed(2);

        // Update quantity displays
        document.querySelectorAll(`.qty-display[data-item-id="${itemId}"]`).forEach(el => {
            el.textContent = quantity;
        });

        // Update item total
        document.querySelectorAll(`.item-total[data-item-id="${itemId}"]`).forEach(el => {
            el.textContent = itemTotal;
        });

        // Update cart totals (optimistic calculation)
        this.updateCartTotals();
    }

    updateCartTotals() {
        let totalItems = 0;
        let subtotal = 0;

        document.querySelectorAll('.cart-item').forEach(item => {
            const itemId = item.dataset.itemId;
            const price = parseFloat(item.dataset.price);
            const qty = parseInt(document.querySelector(`.qty-display[data-item-id="${itemId}"]`).textContent) || 0;
            
            totalItems += qty;
            subtotal += qty * price;
        });

        document.getElementById('total-items').textContent = totalItems;
        document.getElementById('subtotal').textContent = subtotal.toFixed(2);
        document.getElementById('total').textContent = subtotal.toFixed(2);

        // Enable/disable checkout button
        const checkoutBtn = document.getElementById('checkout-btn');
        checkoutBtn.disabled = totalItems === 0;
    }

    async flushPendingUpdate(itemId, productId) {
        const totalChange = this.pendingUpdates.get(itemId) || 0;
        if (totalChange === 0) return;

        this.pendingUpdates.set(itemId, 0);

        try {
            const response = await fetch("{% url 'cart:batch_update_cart' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": this.csrfToken
                },
                body: `product_id=${productId}&total_change=${totalChange}`
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    // Sync with server response
                    if (data.quantity <= 0) {
                        this.removeItemFromDOM(itemId);
                    } else {
                        this.updateItemDisplay(itemId, data.quantity);
                    }
                    this.updateCartTotals();
                }
            } else {
                this.showMessage('Failed to update cart', 'error');
                // Reload page as fallback
                setTimeout(() => window.location.reload(), 1000);
            }
        } catch (error) {
            console.error('Cart update failed:', error);
            this.showMessage('Network error. Reloading...', 'error');
            setTimeout(() => window.location.reload(), 1000);
        }
    }

    async removeItem(itemId, productId) {
        if (this.isGlobalUpdating) return;

        this.isGlobalUpdating = true;
        this.disableAllButtons(true);

        try {
            const response = await fetch("{% url 'cart:remove_from_cart' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": this.csrfToken
                },
                body: `product_id=${productId}`
            });

            if (response.ok) {
                const data = await response.json();
                if (data.success) {
                    this.removeItemFromDOM(itemId);
                    this.updateCartTotals();
                    this.showMessage('Item removed from cart');
                }
            } else {
                this.showMessage('Failed to remove item', 'error');
            }
        } catch (error) {
            console.error('Remove item failed:', error);
            this.showMessage('Network error', 'error');
        } finally {
            this.isGlobalUpdating = false;
            this.disableAllButtons(false);
        }
    }

    removeItemFromDOM(itemId) {
        const itemElement = document.getElementById(`item-${itemId}`);
        if (itemElement) {
            itemElement.style.opacity = '0';
            itemElement.style.transform = 'translateX(100%)';
            setTimeout(() => {
                itemElement.remove();
                this.checkEmptyCart();
            }, 300);
        }
    }

    checkEmptyCart() {
        const cartItems = document.getElementById('cart-items');
        const remainingItems = cartItems.querySelectorAll('.cart-item');
        
        if (remainingItems.length === 0) {
            cartItems.innerHTML = `
                <div id="empty-cart-message" class="text-gray-500 text-center py-12">
                    <p class="text-lg sm:text-xl">Your cart is empty.</p>
                    <a href="{% url 'shop:category' %}" class="inline-block mt-4 text-stone-800 hover:text-stone-600 underline">Continue Shopping</a>
                </div>
            `;
        }
    }

    disableAllButtons(disabled) {
        document.querySelectorAll('.increase-qty, .decrease-qty, .remove-item').forEach(btn => {
            btn.disabled = disabled;
        });
    }

    showMessage(message, type = 'success') {
        const container = document.getElementById('message-container') || this.createMessageContainer();
        const messageDiv = document.createElement('div');
        messageDiv.className = `px-3 sm:px-4 py-2 sm:py-3 rounded-lg text-white text-sm sm:text-base max-w-xs sm:max-w-sm transform transition-all duration-300 ${
            type === 'success' ? 'bg-green-500' : 'bg-red-500'
        }`;
        messageDiv.textContent = message;
        
        container.appendChild(messageDiv);
        
        // Animate in
        setTimeout(() => {
            messageDiv.style.opacity = '1';
            messageDiv.style.transform = 'translateX(0)';
        }, 10);

        // Animate out and remove
        setTimeout(() => {
            messageDiv.style.opacity = '0';
            messageDiv.style.transform = 'translateX(100%)';
            setTimeout(() => {
                if (messageDiv.parentNode) messageDiv.remove();
            }, 300);
        }, 3000);
    }

    createMessageContainer() {
        const container = document.createElement('div');
        container.id = 'message-container';
        container.className = 'fixed top-4 right-4 z-50 space-y-2';
        document.body.appendChild(container);
        return container;
    }

    handleCheckout(e) {
        const checkoutBtn = e.target;
        if (checkoutBtn.disabled) {
            e.preventDefault();
            this.showMessage('Your cart is empty', 'error');
            return;
        }
    
        this.showMessage('Redirecting to checkout...', 'success');
        window.location.href = "/orders/checkout/";  // ✅ Go to checkout page
    }
}    
// Initialize when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
    new OptimizedCartManager();
});
</script>

<style>
.cart-item {
    transform: translateX(0);
    opacity: 1;
}

.cart-item.removing {
    opacity: 0;
    transform: translateX(100%);
}

#message-container > div {
    opacity: 0;
    transform: translateX(100%);
}

@media (max-width: 640px) {
    .qty-display {
        min-width: 2rem;
    }
}
</style>

{% endblock %}