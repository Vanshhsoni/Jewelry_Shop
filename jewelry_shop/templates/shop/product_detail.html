{% extends "core/base.html" %}
{% block content %}

<main class="flex-1">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-16 grid grid-cols-1 md:grid-cols-2 gap-12">

    <!-- Product Image -->
    <div class="w-full aspect-[4/3] rounded-lg overflow-hidden shadow-lg">
      <div class="w-full h-full bg-center bg-no-repeat bg-cover" 
           style='background-image: url("{{ product.image.url }}");'></div>
    </div>

    <!-- Product Info -->
    <div class="flex flex-col gap-6">
      <h1 class="text-3xl font-bold tracking-tight">{{ product.name }}</h1>
      <p class="text-2xl text-stone-700">â‚¹{{ product.price }}</p>
      <p class="text-stone-600">{{ product.description }}</p>

      <!-- Add to Cart Button / Counter -->
      <div id="cart-action">
        {% if product.is_available %}
            <button data-action="add" class="w-full bg-amber-900 text-white py-3 px-6 rounded-md hover:bg-amber-800">
                Add to Cart
            </button>
        {% else %}
            <p class="text-red-600 font-semibold">Product out of stock</p>
        {% endif %}
    </div>
    

  </div>
</main>

<script>
    const cartAction = document.getElementById("cart-action");
    const productId = "{{ product.id }}";
    const csrfToken = "{{ csrf_token }}";
    const addToCartUrl = "{% url 'cart:add_to_cart' %}";
    const updateCartUrl = "{% url 'cart:update_cart_item' %}";
    
    // Use the quantity passed directly from the Django view
    let quantity = {{ initial_quantity }};
    
    // --- A single function to update the UI based on quantity ---
    function updateCartUI(qty) {
        if (qty > 0) {
            cartAction.innerHTML = `
            <div class="flex items-center gap-4">
                <button data-action="decrease" class="px-4 py-2 bg-gray-200 rounded">-</button>
                <span class="font-bold text-lg">${qty}</span>
                <button data-action="increase" class="px-4 py-2 bg-gray-200 rounded">+</button>
            </div>
            `;
        } else {
            cartAction.innerHTML = `
            <button data-action="add" class="w-full bg-amber-900 text-white py-3 px-6 rounded-md hover:bg-amber-800">
                Add to Cart
            </button>
            `;
        }
    }
    
    // --- A single function to handle all server communication ---
    function performCartAction(url, body) {
        // Optimistic UI update: Change the number immediately
        if (body.has('change')) {
            const change = parseInt(body.get('change'));
            quantity += change;
            updateCartUI(quantity);
        } else {
            quantity = 1; // Assume adding for the first time
            updateCartUI(quantity);
        }
        
        fetch(url, {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
                "X-CSRFToken": csrfToken
            },
            body: body.toString()
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // Server has confirmed. Update quantity with the official value.
                quantity = data.quantity;
                updateCartUI(quantity);
                // You can also dispatch an event here to update a global cart icon
                // window.dispatchEvent(new CustomEvent('cartUpdated', { detail: { total_items: data.total_items } }));
            } else {
                // If the server fails, revert the change
                console.error("Cart update failed:", data.error);
                const change = parseInt(body.get('change')) || -1; // Revert the add or the change
                quantity -= change;
                updateCartUI(quantity);
            }
        });
    }
    
    // --- Use Event Delegation for all clicks ---
    cartAction.addEventListener("click", (e) => {
        const action = e.target.dataset.action;
        if (!action) return;
    
        if (action === "add") {
            const body = new URLSearchParams({ product_id: productId, quantity: 1 });
            performCartAction(addToCartUrl, body);
        } else if (action === "increase") {
            const body = new URLSearchParams({ product_id: productId, change: 1 });
            performCartAction(updateCartUrl, body);
        } else if (action === "decrease") {
            const body = new URLSearchParams({ product_id: productId, change: -1 });
            performCartAction(updateCartUrl, body);
        }
    });
    
    // --- Initial Render on Page Load ---
    {% if product.is_available %}
    updateCartUI(quantity);
{% endif %}
    </script>
{% endblock %}
