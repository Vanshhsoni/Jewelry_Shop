{% extends "core/base.html" %}
{% block content %}

<main class="flex-1">
  <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-16 grid grid-cols-1 md:grid-cols-2 gap-12">

    <!-- Product Image -->
    <div class="w-full aspect-[4/3] rounded-lg overflow-hidden shadow-lg">
      <div class="w-full h-full bg-center bg-no-repeat bg-cover" 
           style='background-image: url("{{ product.image.url }}");'></div>
    </div>

    <!-- Product Info -->
    <div class="flex flex-col gap-6">
      <h1 class="text-3xl font-bold tracking-tight">{{ product.name }}</h1>
      <p class="text-2xl text-stone-700">â‚¹{{ product.price }}</p>
      <p class="text-stone-600">{{ product.description }}</p>

      <!-- Add to Cart Button / Counter -->
      <div id="cart-action">
        <button id="add-to-cart-btn" class="w-full bg-amber-900 text-white py-3 px-6 rounded-md hover:bg-amber-800">
          Add to Cart
        </button>
      </div>
    </div>

  </div>
</main>

<script>
const cartAction = document.getElementById("cart-action");

// Fetch existing quantity in cart
let quantity = 0;

fetch("{% url 'cart:add_to_cart' %}", {
    method: "POST",
    headers: {
        "Content-Type": "application/x-www-form-urlencoded",
        "X-CSRFToken": "{{ csrf_token }}"
    },
    body: "product_id={{ product.id }}&check_only=1"
})
.then(res => res.json())
.then(data => {
    if(data.exists){
        quantity = data.quantity;
        renderCounter(quantity);
    }
});

function renderCounter(qty){
    cartAction.innerHTML = `
    <div class="flex items-center gap-4">
      <button id="decrease-qty" class="px-4 py-2 bg-gray-200 rounded">-</button>
      <span id="qty-display" class="font-bold text-lg">${qty}</span>
      <button id="increase-qty" class="px-4 py-2 bg-gray-200 rounded">+</button>
    </div>
    `;

    document.getElementById("increase-qty").addEventListener("click", ()=>updateQty(1));
    document.getElementById("decrease-qty").addEventListener("click", ()=>updateQty(-1));
}

document.getElementById("add-to-cart-btn")?.addEventListener("click", ()=>{
    fetch("{% url 'cart:add_to_cart' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: "product_id={{ product.id }}&quantity=1"
    })
    .then(res => res.json())
    .then(data=>{
        if(data.success){
            quantity = data.quantity;
            renderCounter(quantity);
        }
    });
});

function updateQty(change){
    fetch("{% url 'cart:update_cart_item' %}", {
        method: "POST",
        headers:{
            "Content-Type":"application/x-www-form-urlencoded",
            "X-CSRFToken":"{{ csrf_token }}"
        },
        body: `product_id={{ product.id }}&change=${change}`
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.success){
            quantity = data.quantity;
            if(quantity <= 0){
                cartAction.innerHTML = `<button id="add-to-cart-btn" class="w-full bg-amber-900 text-white py-3 px-6 rounded-md hover:bg-amber-800">Add to Cart</button>`;
                document.getElementById("add-to-cart-btn").addEventListener("click", ()=>{
                    fetch("{% url 'cart:add_to_cart' %}", {
                        method: "POST",
                        headers:{
                            "Content-Type":"application/x-www-form-urlencoded",
                            "X-CSRFToken":"{{ csrf_token }}"
                        },
                        body: "product_id={{ product.id }}&quantity=1"
                    }).then(res=>res.json()).then(data=>{
                        if(data.success){ quantity=data.quantity; renderCounter(quantity); }
                    });
                });
            } else {
                document.getElementById("qty-display").innerText = quantity;
            }
        }
    });
}
</script>

{% endblock %}
